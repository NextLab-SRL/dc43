{% extends "base.html" %}
{% block content %}
<h1>Contract {{ contract.id }} {{ contract.version }}</h1>
<p><a href="/contracts/{{ contract.id }}">Back to versions</a></p>
<p>
  <a class="btn btn-secondary btn-sm" href="/api/contracts/{{ contract.id }}/{{ contract.version }}">Download JSON</a>
  <a class="btn btn-primary btn-sm" href="/contracts/{{ contract.id }}/{{ contract.version }}/edit">Edit</a>
</p>

<ul class="nav nav-tabs" id="contractTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="schema-tab" data-bs-toggle="tab" data-bs-target="#schema" type="button" role="tab">Schema</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="quality-tab" data-bs-toggle="tab" data-bs-target="#quality" type="button" role="tab">Quality</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="change-log-tab" data-bs-toggle="tab" data-bs-target="#change-log" type="button" role="tab">Change Log</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json" type="button" role="tab">JSON</button>
  </li>
</ul>
<div class="tab-content mt-3" id="contractTabsContent">
  <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
    <dl class="row">
      <dt class="col-sm-3">Name</dt><dd class="col-sm-9">{{ contract.name }}</dd>
      {% if contract.description and contract.description.usage %}
      <dt class="col-sm-3">Description</dt><dd class="col-sm-9">{{ contract.description.usage }}</dd>
      {% endif %}
      {% if contract.servers %}
      <dt class="col-sm-3">Servers</dt>
      <dd class="col-sm-9">
        <ul class="list-unstyled mb-0">
        {% for s in contract.servers %}
          <li>
            {{ s.server }}{% if s.type %} ({{ s.type }}){% endif %}:
            {% if s.path %}{{ s.path }}{% elif s.dataset %}{{ s.dataset }}{% endif %}
          </li>
        {% endfor %}
        </ul>
      </dd>
      {% endif %}
    </dl>
    {% if datasets %}
    <h5>Datasets</h5>
    <ul>
      {% for d in datasets %}
      <li><a href="/datasets/{{ d.dataset_name }}/{{ d.dataset_version }}">{{ d.dataset_name }} {{ d.dataset_version }}</a> - {{ d.status }}</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  <div class="tab-pane fade" id="schema" role="tabpanel" aria-labelledby="schema-tab">
    {% for s in contract.schema %}
      <h5>{{ s.name }}</h5>
      <table class="table table-sm">
        <thead><tr><th>Name</th><th>Type</th><th>Required</th></tr></thead>
        <tbody>
        {% for p in s.properties %}
        <tr><td>{{ p.name }}</td><td>{{ p.physicalType }}</td><td>{{ 'yes' if p.required else 'no' }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  </div>
  <div class="tab-pane fade" id="quality" role="tabpanel" aria-labelledby="quality-tab">
    {% if field_quality %}
    <h5>Field quality rules</h5>
    {% for field in field_quality %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ field.name }}</strong>
          {% if field.type %}<span class="text-muted">({{ field.type }})</span>{% endif %}
        </div>
        <span class="badge {{ 'bg-success' if field.required else 'bg-secondary' }}">{{ 'Required' if field.required else 'Optional' }}</span>
      </div>
      <div class="card-body">
        {% if field.rules %}
          {% for rule in field.rules %}
          <div class="mb-3">
            <h6 class="mb-1">{{ rule.title }}</h6>
            <ul class="small mb-2">
              {% for text in rule.conditions %}
              <li>{{ text }}</li>
              {% endfor %}
            </ul>
            {% if rule.severity or rule.dimension %}
            <p class="small text-muted mb-0">
              {% if rule.severity %}<span class="me-3">Severity: {{ rule.severity }}</span>{% endif %}
              {% if rule.dimension %}<span>Dimension: {{ rule.dimension }}</span>{% endif %}
            </p>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
        <p class="text-muted mb-0">No quality rules defined for this field.</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
    <p>No field-level quality rules defined.</p>
    {% endif %}

    {% if dataset_quality %}
    <h5>Dataset-level quality rules</h5>
    {% for section in dataset_quality %}
    <div class="card mb-3">
      <div class="card-header">
        <strong>{{ section.name }}</strong>
      </div>
      <div class="card-body">
        {% for rule in section.rules %}
        <div class="mb-3">
          <h6 class="mb-1">{{ rule.title }}</h6>
          <ul class="small mb-2">
            {% for text in rule.conditions %}
            <li>{{ text }}</li>
            {% endfor %}
          </ul>
          {% if rule.severity or rule.dimension %}
          <p class="small text-muted mb-0">
            {% if rule.severity %}<span class="me-3">Severity: {{ rule.severity }}</span>{% endif %}
            {% if rule.dimension %}<span>Dimension: {{ rule.dimension }}</span>{% endif %}
          </p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
    {% endif %}

    {% if expectations %}
    <h5>SQL predicates</h5>
    <table class="table table-sm">
      <thead><tr><th>Name</th><th>Predicate</th></tr></thead>
      <tbody>
      {% for name, expr in expectations.items() %}
      <tr><td>{{ name }}</td><td><code>{{ expr }}</code></td></tr>
      {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
  <div class="tab-pane fade" id="change-log" role="tabpanel" aria-labelledby="change-log-tab">
    {% if change_log %}
    <div class="list-group">
      {% for entry in change_log %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <span class="badge {{ status_badges.get(entry.status, 'bg-secondary') }}">{{ entry.status_label }}</span>
            <strong class="ms-2">{{ entry.scope_label }}</strong>
          </div>
          {% if entry.kind %}
          <small class="text-muted text-uppercase">{{ entry.kind }}</small>
          {% endif %}
        </div>
        {% if entry.summary %}
        <p class="mb-1 mt-2">{{ entry.summary }}</p>
        {% endif %}
        {% if entry.constraint %}
        <p class="mb-1 small text-muted"><strong>Constraint:</strong> {{ entry.constraint }}</p>
        {% endif %}
        {% if entry.rule %}
        <p class="mb-1 small text-muted"><strong>Rule:</strong> {{ entry.rule }}</p>
        {% endif %}
        {% if entry.details_text %}
        <pre class="small bg-light p-2 rounded">{{ entry.details_text }}</pre>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No change log entries available.</p>
    {% endif %}
  </div>
  <div class="tab-pane fade" id="json" role="tabpanel" aria-labelledby="json-tab">
    <pre class="small">{{ contract | tojson(indent=2) }}</pre>
  </div>
</div>
{% endblock %}

