{% extends "base.html" %}
{% block content %}
<h1>Pipeline Runs</h1>
{% if message %}<div class="alert alert-success">{{ message }}</div>{% endif %}
{% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
<form class="row g-3 mb-4" method="post" action="/pipeline/run" id="run-form">
  <div class="col-md-4">
    <label class="form-label">Scenario</label>
    <select class="form-select" name="scenario" id="scenario">
      <option value="">Select a scenario</option>
      {% for key, sc in scenarios.items() %}
      <option value="{{ key }}">{{ sc.label }}</option>
      {% endfor %}
    </select>
    <div class="form-text" id="scenario-desc"></div>
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary w-100" type="submit" id="run-btn">Run Pipeline</button>
  </div>
</form>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Contract ID</th>
        <th>Contract Version</th>
        <th>Draft Version</th>
        <th>Dataset</th>
        <th>Version</th>
        <th>Run Type</th>
        <th>Status</th>
        <th>Violations</th>
        <th>DQ Details</th>
      </tr>
    </thead>
    <tbody>
    {% for r in records %}
      <tr>
        <td>
          {% if r.contract_id %}
            <a href="/contracts/{{ r.contract_id }}">{{ r.contract_id }}</a>
          {% else %}
            <span class="text-muted">No contract</span>
          {% endif %}
        </td>
        <td>
          {% if r.contract_id and r.contract_version %}
            <a href="/contracts/{{ r.contract_id }}/{{ r.contract_version }}">{{ r.contract_version }}</a>
          {% elif r.contract_id %}
            <span class="text-muted">No version</span>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
        <td>
          {% if r.contract_id and r.draft_contract_version %}
            <a href="/contracts/{{ r.contract_id }}/{{ r.draft_contract_version }}">{{ r.draft_contract_version }}</a>
          {% elif r.draft_contract_version %}
            <span class="text-muted">{{ r.draft_contract_version }}</span>
          {% endif %}
        </td>
        <td>
          {% if r.dataset_name %}
            <a href="/datasets/{{ r.dataset_name }}">{{ r.dataset_name }}</a>
          {% else %}
            <span class="text-muted">Unnamed</span>
          {% endif %}
        </td>
        <td>
          {% if r.dataset_name %}
            <a href="/datasets/{{ r.dataset_name }}/{{ r.dataset_version }}">{{ r.dataset_version }}</a>
          {% else %}
            {{ r.dataset_version }}
          {% endif %}
        </td>
        <td>{{ r.run_type }}</td>
        {% set output_details = r.dq_details.get('output', {}) %}
        <td>
          {{ r.status }}
          {% if output_details.get('warnings') %}
            <span class="text-warning ms-1" title="Validation warnings">&#9888;</span>
          {% endif %}
          {% if output_details.get('errors') %}
            <span class="text-danger ms-1" title="Schema errors">&#10060;</span>
          {% endif %}
        </td>
        <td>
          {% set fails = output_details.get('failed_expectations', {}) %}
          {% set schema_errors = output_details.get('errors', []) %}
          {% if output_details.get('violation_strategy') %}
            <div>Strategy: {{ output_details.get('violation_strategy') }}</div>
          {% endif %}
          {% if schema_errors %}
            <div>Schema errors: {{ schema_errors | length }}</div>
          {% endif %}
          {% if fails %}
            {% for key, info in fails.items() %}
              <div>{{ key }} ({{ info.count }})</div>
            {% endfor %}
          {% endif %}
          {% set aux = output_details.get('auxiliary_datasets', []) %}
          {% if aux %}
            <div class="small text-muted">
              {% for entry in aux %}
                <div>{{ entry.kind | capitalize }} → <code>{{ entry.dataset }}</code></div>
              {% endfor %}
            </div>
          {% endif %}
          {% set dq_aux = output_details.get('dq_auxiliary_statuses', []) %}
          {% if dq_aux %}
            <div class="small text-muted">
              {% for entry in dq_aux %}
                {% set details = entry.get('details') if entry.get('details') is mapping else {} %}
                <div>
                  <code>{{ entry.get('dataset_id') }}</code> status → {{ entry.get('status') }}
                  {% if details.get('draft_contract_version') %}
                    (draft {{ details.get('draft_contract_version') }})
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}
          {% if not fails and not schema_errors %}
            {{ r.violations }}
          {% endif %}
        </td>
        <td>
          <details>
            <summary>Show</summary>
            <div class="accordion mt-2" id="dq-{{ loop.index }}">
              <div class="accordion-item">
                <h2 class="accordion-header" id="dq-input-{{ loop.index }}-h">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dq-input-{{ loop.index }}">Input</button>
                </h2>
                <div id="dq-input-{{ loop.index }}" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    {% for key in ['orders', 'customers'] %}
                      {% if r.dq_details.get(key) %}
                      <h6 class="text-capitalize">{{ key }}</h6>
                      <pre class="small">{{ r.dq_details.get(key) | tojson(indent=2) }}</pre>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="dq-output-{{ loop.index }}-h">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dq-output-{{ loop.index }}">Output</button>
                </h2>
                <div id="dq-output-{{ loop.index }}" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    {% set fails = output_details.get('failed_expectations', {}) %}
                    {% if fails %}
                      {% for key, info in fails.items() %}
                        <div class="mb-2"><strong>{{ key }}</strong>: <code>{{ info.expression }}</code> ({{ info.count }})
                        {% if info.examples %}
                          <details class="small"><summary>Examples</summary><pre class="small mb-0">{{ info.examples | tojson(indent=2) }}</pre></details>
                        {% endif %}
                        </div>
                      {% endfor %}
                    {% endif %}
                    {% set schema_errors = output_details.get('errors', []) %}
                    {% if schema_errors %}
                      <div class="mb-2">
                        <strong>Schema errors</strong>
                        <ul class="small mb-0 ps-3">
                          {% for err in schema_errors %}
                            <li>{{ err }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% set warnings = output_details.get('warnings', []) %}
                    {% if warnings %}
                      <div class="mb-2">
                        <strong>Warnings</strong>
                        <ul class="small mb-0 ps-3">
                          {% for warning in warnings %}
                            <li>{{ warning }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% set aux = output_details.get('auxiliary_datasets', []) %}
                    {% if aux %}
                      <div class="mb-2">
                        <strong>Auxiliary datasets</strong>
                        <ul class="small mb-0 ps-3">
                          {% for entry in aux %}
                            <li><span class="text-capitalize">{{ entry.kind }}</span>: <code>{{ entry.dataset }}</code>{% if entry.path %} ({{ entry.path }}){% endif %}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% set dq_aux = output_details.get('dq_auxiliary_statuses', []) %}
                    {% if dq_aux %}
                      <div class="mb-2">
                        <strong>Auxiliary DQ statuses</strong>
                        <ul class="small mb-0 ps-3">
                          {% for entry in dq_aux %}
                            {% set details = entry.get('details') if entry.get('details') is mapping else {} %}
                            <li>
                              <code>{{ entry.get('dataset_id') }}</code> → {{ entry.get('status') }}
                              {% if details.get('draft_contract_version') %}
                                (draft {{ details.get('draft_contract_version') }})
                              {% endif %}
                              {% if details.get('violations') is not none %}
                                – violations: {{ details.get('violations') }}
                              {% endif %}
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% if output_details.get('violation_strategy') %}
                      <div class="mb-2 small text-muted">Violation strategy: {{ output_details.get('violation_strategy') }}</div>
                    {% endif %}
                    <pre class="small mb-0">{{ output_details | tojson(indent=2) }}</pre>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
<script>
    const scenarios = {{ scenarios | tojson }};
    const scenarioSel = document.getElementById('scenario');
    const descEl = document.getElementById('scenario-desc');
    scenarioSel.addEventListener('change', () => {
      const sc = scenarios[scenarioSel.value];
      if (sc) {
        const parts = [sc.description];
        if (sc.diagram) {
          parts.push(sc.diagram);
        }
        descEl.innerHTML = parts.join('');
        const diagrams = descEl.querySelectorAll('.mermaid');
        if (window.mermaid && diagrams.length) {
          window.mermaid.init(undefined, diagrams);
        }
      } else {
        descEl.innerHTML = '';
      }
    });
    const runForm = document.getElementById('run-form');
    const runBtn = document.getElementById('run-btn');
    runForm.addEventListener('submit', () => {
      runBtn.disabled = true;
      runBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running...';
    });
</script>
{% if not records %}<p>No runs recorded.</p>{% endif %}
{% endblock %}
