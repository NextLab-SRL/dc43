{% extends "base.html" %}
{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<div class="row align-items-center mb-4">
  <div class="col-lg-8">
    <h1 class="display-5 fw-semibold mb-3">Altair Retail data product suite</h1>
    <p class="lead mb-3">
      Explore how Altair Retail packages operational sources, a modeled star schema,
      a lightweight demand model, consumer activation, and executive analytics into
      a single governed flow.
    </p>
    <p class="text-muted mb-4">Business date: {{ business_date or "2024-03-31" }}</p>
    <p class="small text-muted">Explore the activation planner and dashboard directly on this page using the
      tabs in the experience section below.</p>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h2 class="h5">KPI preview</h2>
        {% for metric in kpi_preview %}
        <div class="d-flex justify-content-between align-items-baseline py-2 border-bottom">
          <div>
            <div class="fw-semibold">{{ metric.label }}</div>
            <div class="text-muted small">{{ metric.semantic.expression }}</div>
          </div>
          <div class="fs-5">{{ metric.value_display }}</div>
        </div>
        {% endfor %}
        <div class="small text-muted pt-2">Semantic layer metadata is sourced from the
          packaged KPI mart, mirroring what BI tools would read.</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-lg-5">
    <div class="card h-100 shadow-sm border-0" id="retail-run-card">
      <div class="card-body">
        <h2 class="h5">Run the Altair Retail pipeline</h2>
        <p class="mb-3">The fixtures on this page are cached from the latest demo run. Trigger a new
          execution to reload the operational sources, rebuild the star schema, score the
          demand model, and publish the downstream assets.</p>
        <ol class="small ps-3 mb-3">
          <li>Load operational sources (`retail_pos_transactions`, `retail_inventory_snapshot`, `retail_product_catalog`).</li>
          <li>Assemble the modelled snowflake schema (`retail_sales_fact` plus dimensions).</li>
          <li>Engineer ML features and forecast demand.</li>
          <li>Publish marketing offers and aggregate the KPI mart.</li>
        </ol>
        <form method="post" action="/retail-demo/run" class="d-flex align-items-center gap-3 flex-wrap">
          <button type="submit" class="btn btn-success">Re-run demo pipeline</button>
          <span class="small text-muted">Caches refresh instantly with the packaged sample data.</span>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-body">
        <h2 class="h5">Sample code</h2>
        <p class="small text-muted">Recreate the walkthrough in notebooks or scripts with the bundled helpers.</p>
        <pre class="mb-0"><code class="language-python">from dc43_demo_app.retail_demo import run_retail_demo

run = run_retail_demo()
print(f"Business date: {run.kpis[0]['business_date']}")
print(f"Sales fact rows: {len(run.star_schema.sales_fact)}")
print(f"Forecast outputs: {len(run.forecasts)}")
for metric in run.kpis:
    print(metric["metric_id"], metric["value"])</code></pre>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mb-5" id="retail-timeline-card">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h2 class="h5 mb-1">Timeline player</h2>
        <p class="small text-muted mb-0">Animate six months of Altair Retail operations. The player pauses at milestones so
          you can narrate incidents, releases, and stakeholder outcomes.</p>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button class="btn btn-primary btn-sm" id="retailTimelinePlay" type="button">Play timeline</button>
        <button class="btn btn-outline-secondary btn-sm" id="retailTimelineNext" type="button">Next milestone</button>
        <div class="small text-muted">Active:
          <span class="fw-semibold" id="retailTimelineActiveLabel">Not started</span>
        </div>
      </div>
    </div>
    <div class="progress mb-4" style="height: 6px;">
      <div class="progress-bar bg-primary" id="retailTimelineProgress" role="progressbar" style="width: 0%;"
        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="list-group small" id="retailTimelineList">
          {% for event in timeline_events %}
          <button type="button"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
            data-index="{{ event.index }}">
            <div class="ms-2 me-auto">
              <div class="fw-semibold">{{ event.date }} · {{ event.title }}</div>
              <div class="text-muted">{{ event.summary }}</div>
            </div>
            <span class="badge {{ event.badge_class }} rounded-pill text-uppercase">{{ event.milestone_label }}</span>
          </button>
          {% endfor %}
        </div>
      </div>
      <div class="col-lg-7">
        <div class="border rounded p-4 h-100 bg-light" id="retailTimelineDetail">
          <div class="d-flex align-items-center gap-2 mb-2">
            <span class="badge text-bg-secondary text-uppercase" id="retailTimelineDetailBadge">Milestone</span>
            <span class="fw-semibold" id="retailTimelineDetailTitle">Select a milestone to begin the demo.</span>
          </div>
          <p class="small text-muted mb-3" id="retailTimelineDetailNarrative">Use the play controls to animate the story or
            click an individual milestone to jump ahead.</p>
          <div id="retailTimelineDetailInsights" class="mb-3"></div>
          <div id="retailTimelineDetailCallouts"></div>
          <div id="retailTimelineDetailLinks" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mb-5">
  <div class="card-body">
    <h2 class="h5">Flow at a glance</h2>
    <p class="small text-muted">Each block represents a data product boundary. Internal datasets stay inside the
      product while exposed ports are surfaced downstream.</p>
    <div class="mermaid">
graph LR
  A["Retail operational foundation<br/>Source feeds"] --> B["Retail star schema<br/>Modelled data"]
  B --> C["Retail demand intelligence<br/>ML features &amp; forecasts"]
  C --> D["Customer experience<br/>Marketing activation"]
  B --> E["Executive KPI mart<br/>Aggregated analytics"]
  E --> F["Executive dashboard<br/>BI &amp; finance views"]
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mb-5">
  <div class="card-body">
    <h2 class="h5">Dataset lineage</h2>
    <p class="small text-muted">Datasets are grouped by the data product zone that owns them. Ports surface public
      interfaces while internal assets stay inside their product boundary.</p>
    <div class="mermaid">
{{ dataset_lineage | safe }}
    </div>
  </div>
</div>

<h2 class="h4 mb-3">Catalog crosslinks</h2>
<p class="text-muted">Jump between data products, datasets, and contracts without leaving the walkthrough.</p>
<ul class="nav nav-tabs" id="catalogTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="catalog-products-tab" data-bs-toggle="tab" data-bs-target="#catalog-products" type="button" role="tab" aria-controls="catalog-products" aria-selected="true">Data products</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="catalog-datasets-tab" data-bs-toggle="tab" data-bs-target="#catalog-datasets" type="button" role="tab" aria-controls="catalog-datasets" aria-selected="false">Datasets</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="catalog-contracts-tab" data-bs-toggle="tab" data-bs-target="#catalog-contracts" type="button" role="tab" aria-controls="catalog-contracts" aria-selected="false">Contracts</button>
  </li>
</ul>
<div class="tab-content pt-3" id="catalogTabsContent">
  <div class="tab-pane fade show active" id="catalog-products" role="tabpanel" aria-labelledby="catalog-products-tab">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col">Product</th>
            <th scope="col">Owner</th>
            <th scope="col">Tags</th>
            <th scope="col">Ports</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr id="{{ product.anchor }}">
            <td>
              <a class="fw-semibold" href="{{ product.url }}" target="_blank" rel="noopener">{{ product.name }}</a>
              <div class="small text-muted">{{ product.identifier }}</div>
              <div class="small"><a class="link-secondary" href="#{{ product.anchor }}">Highlight in walkthrough</a></div>
            </td>
            <td class="small">{{ product.owner.replace('-', ' ') | title }}</td>
            <td>
              {% for tag in product.tags %}
              <span class="badge text-bg-light text-uppercase">{{ tag }}</span>
              {% endfor %}
            </td>
            <td class="small">
              <div><span class="text-muted text-uppercase">Inputs</span>: {{ product.inputs | join(', ') if product.inputs else 'None' }}</div>
              <div><span class="text-muted text-uppercase">Outputs</span>: {{ product.outputs | join(', ') }}</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="catalog-datasets" role="tabpanel" aria-labelledby="catalog-datasets-tab">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col">Dataset</th>
            <th scope="col">Zone</th>
            <th scope="col">Type</th>
            <th scope="col">Data product</th>
            <th scope="col">Contract</th>
            <th scope="col">Port</th>
            <th scope="col">Rows</th>
            <th scope="col">Dependencies</th>
          </tr>
        </thead>
        <tbody>
          {% for dataset in dataset_catalog %}
          <tr id="{{ dataset.anchor }}">
            <td>
              <a class="fw-semibold" href="{{ dataset.url }}" target="_blank" rel="noopener">{{ dataset.identifier }}</a>
              <div class="small text-muted">{{ dataset.description }}</div>
              {% if dataset.internal %}
              <span class="badge text-bg-warning text-uppercase mt-1">Internal only</span>
              {% endif %}
              <div class="small"><a class="link-secondary" href="#{{ dataset.anchor }}">Highlight in walkthrough</a></div>
            </td>
            <td class="small">
              {% set zone_parts = dataset.zone_label.split(' — ') %}
              <span class="badge {{ dataset.zone_badge }} text-uppercase">{{ zone_parts[0] }}</span>
              {% if zone_parts|length > 1 %}
              <div class="text-muted">{{ zone_parts[1] }}</div>
              {% endif %}
            </td>
            <td class="small text-uppercase">{{ dataset.kind }}</td>
            <td class="small">
              {% if dataset.data_product %}
              <a href="{{ dataset.data_product.url }}" target="_blank" rel="noopener">{{ dataset.data_product.name }}</a>
              <div class="text-muted">{{ dataset.data_product.identifier }}</div>
              <div class="small"><a class="link-secondary" href="#{{ dataset.data_product.anchor }}">Highlight</a></div>
              {% else %}
              —
              {% endif %}
            </td>
            <td class="small">
              <a href="{{ dataset.contract_url }}" target="_blank" rel="noopener">{{ dataset.contract_id }}</a>
              <div class="small"><a class="link-secondary" href="#{{ dataset.contract_anchor }}">Highlight</a></div>
            </td>
            <td class="small">{{ dataset.output_port or '—' }}</td>
            <td class="small">{{ dataset.row_count }}</td>
            <td class="small">
              {% if dataset.dependencies %}
              {% for dep in dataset.dependencies %}
              <a href="{{ dep.url }}" target="_blank" rel="noopener" class="d-inline-block">{{ dep.identifier }}</a>{% if not loop.last %}, {% endif %}
              {% endfor %}
              {% else %}
              None
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="catalog-contracts" role="tabpanel" aria-labelledby="catalog-contracts-tab">
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for contract in contract_cards %}
      <div class="col" id="{{ contract.anchor }}">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body">
            <h3 class="h6 fw-semibold mb-1"><a href="{{ contract.url }}" target="_blank" rel="noopener">{{ contract.contract_id }}</a></h3>
            <div class="small mb-2"><a class="link-secondary" href="#{{ contract.anchor }}">Highlight in walkthrough</a></div>
            <div class="small text-muted mb-3">{{ contract.dataset_count }} dataset{{ 's' if contract.dataset_count != 1 else '' }} ·
              {% for kind in contract.kinds %}<span class="badge text-bg-light text-uppercase me-1">{{ kind }}</span>{% endfor %}</div>
            <div class="mb-3">
              <div class="small text-muted text-uppercase mb-1">Datasets</div>
              <ul class="list-unstyled mb-0">
                {% for dataset_id in contract.dataset_ids %}
                <li>
                  <a href="/datasets/{{ dataset_id }}" target="_blank" rel="noopener">{{ dataset_id }}</a>
                  <a class="link-secondary small ms-1" href="#dataset-{{ dataset_id }}">Highlight</a>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% if contract.product_refs %}
            <div>
              <div class="small text-muted text-uppercase mb-1">Data products</div>
              <ul class="list-unstyled mb-0">
                {% for ref in contract.product_refs %}
                <li>
                  {% if ref.url %}
                  <a href="{{ ref.url }}" target="_blank" rel="noopener">{{ ref.name }}</a>
                  {% else %}
                  {{ ref.name or ref.identifier }}
                  {% endif %}
                  <span class="text-muted small">({{ ref.identifier }})</span>
                  {% if ref.anchor %}
                  <a class="link-secondary small ms-1" href="#{{ ref.anchor }}">Highlight</a>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<h2 class="h4 mt-5 mb-3">Experience &amp; analytics walkthrough</h2>
<p class="text-muted">Switch between the customer offer summary, activation planning workspace, and
  executive dashboard without leaving the page.</p>
<ul class="nav nav-tabs" id="experienceTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="experience-offers-tab" data-bs-toggle="tab"
      data-bs-target="#experience-offers" type="button" role="tab" aria-controls="experience-offers"
      aria-selected="true">Offer highlights</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="experience-activation-tab" data-bs-toggle="tab"
      data-bs-target="#experience-activation" type="button" role="tab" aria-controls="experience-activation"
      aria-selected="false">Marketing activation</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="experience-dashboard-tab" data-bs-toggle="tab"
      data-bs-target="#experience-dashboard" type="button" role="tab" aria-controls="experience-dashboard"
      aria-selected="false">Executive dashboard</button>
  </li>
</ul>
<div class="tab-content pt-3" id="experienceTabsContent">
  <div class="tab-pane fade show active" id="experience-offers" role="tabpanel"
    aria-labelledby="experience-offers-tab">
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for store in store_cards %}
      <div class="col">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h3 class="h5 mb-0">{{ store.store_name }}</h3>
                <div class="text-muted small">{{ store.region }} · {{ store.format | title }}</div>
              </div>
              <span class="badge text-bg-primary">{{ store.offer_count }} offers</span>
            </div>
            <p class="mb-1">Leading category: <strong>{{ store.headline_category }}</strong></p>
            <p class="mb-3 text-muted small">Primary KPI: {{ store.headline_metric.replace('_', ' ') | title }}</p>
            <div class="mb-3">
              <div class="small text-muted text-uppercase mb-1">Recommended discount</div>
              <div class="fw-semibold fs-5">{{ '%.1f' | format(store.discount_pct) }}%</div>
            </div>
            <div class="mb-2">
              <div class="small text-muted">Forecast confidence</div>
              <div class="progress" role="progressbar" aria-valuenow="{{ store.confidence_pct }}" aria-valuemin="0"
                aria-valuemax="100">
                <div class="progress-bar bg-success" style="width: {{ '%.0f' | format(store.confidence_pct) }}%"></div>
              </div>
            </div>
            <div>
              <div class="small text-muted">Sell-through focus</div>
              <div class="progress" role="progressbar" aria-valuenow="{{ store.sell_through_pct }}" aria-valuemin="0"
                aria-valuemax="100">
                <div class="progress-bar bg-info" style="width: {{ '%.1f' | format(store.sell_through_pct) }}%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="col">
        <div class="alert alert-info mb-0">No offers generated by the demo pipeline yet.</div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="tab-pane fade" id="experience-activation" role="tabpanel"
    aria-labelledby="experience-activation-tab">
    {% for store in activation_stores %}
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h3 class="h6 mb-0">{{ store.store_name }}</h3>
          <div class="text-muted small">{{ store.region }} · {{ store.format | title }}{% if store.square_feet %} ·
            {{ store.square_feet | int }} sq ft{% endif %}</div>
        </div>
        <span class="badge text-bg-primary">{{ store.offers | length }} active offers</span>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-4">
            <h4 class="h6 text-uppercase text-muted">KPI focus</h4>
            <ul class="list-unstyled mb-0">
              {% for mix in store.metric_mix %}
              <li class="mb-2">
                <span class="badge text-bg-secondary text-uppercase">{{ mix.metric_label }}</span>
                <div class="text-muted small">{{ mix.count }} offer{% if mix.count != 1 %}s{% endif %} · {{ '%.0f' | format(mix.share) }}%
                  of plan</div>
              </li>
              {% else %}
              <li class="text-muted small">No KPI emphasis recorded.</li>
              {% endfor %}
            </ul>
          </div>
          <div class="col-md-8">
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Offer</th>
                    <th scope="col" class="text-center">Category</th>
                    <th scope="col" class="text-center">KPI</th>
                    <th scope="col" class="text-end">Discount</th>
                    <th scope="col" class="text-end">Forecast units</th>
                    <th scope="col" class="text-end">Confidence</th>
                    <th scope="col" class="text-end">Sell-through</th>
                  </tr>
                </thead>
                <tbody>
                  {% for offer in store.offers %}
                  <tr>
                    <th scope="row">
                      <div class="fw-semibold">{{ offer.offer_id }}</div>
                      <div class="text-muted small">Customer {{ offer.customer_id }}</div>
                    </th>
                    <td class="text-center">{{ offer.category }}</td>
                    <td class="text-center">{{ offer.primary_metric_label }}</td>
                    <td class="text-end">{{ '%.1f' | format(offer.discount_pct) }}%</td>
                    <td class="text-end">
                      {{ '%.0f' | format(offer.forecast_units) }}
                      <div class="progress mt-1" role="progressbar" aria-valuenow="{{ offer.forecast_share }}"
                        aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar" style="width: {{ '%.0f' | format(offer.forecast_share) }}%"></div>
                      </div>
                    </td>
                    <td class="text-end">{{ '%.0f' | format(offer.confidence_pct) }}%</td>
                    <td class="text-end">{{ '%.1f' | format(offer.sell_through_pct) }}%</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info">No offers generated by the demo pipeline yet.</div>
    {% endfor %}
  </div>
  <div class="tab-pane fade" id="experience-dashboard" role="tabpanel"
    aria-labelledby="experience-dashboard-tab">
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
      {% for metric in dashboard_metrics %}
      <div class="col">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body">
            <div class="text-muted small">{{ metric.metric_id }}</div>
            <h3 class="h5 mb-2">{{ metric.label }}</h3>
            <div class="display-6 fw-semibold">{{ metric.value_display }}</div>
            <p class="text-muted small mt-3 mb-0">{{ metric.semantic.description }}</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h4 class="h6">Sales by region</h4>
            <ul class="list-group list-group-flush">
              {% for region in dashboard_region_rows %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ region.label }}</span>
                  <span class="fw-semibold">${{ '%.0f' | format(region.value) }}</span>
                </div>
                <div class="progress mt-2" role="progressbar" aria-valuenow="{{ region.share }}" aria-valuemin="0"
                  aria-valuemax="100">
                  <div class="progress-bar" style="width: {{ '%.0f' | format(region.share) }}%"></div>
                </div>
                <div class="text-muted small mt-1">{{ '%.0f' | format(region.share) }}% of gross sales</div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h4 class="h6">Sales by category</h4>
            <ul class="list-group list-group-flush">
              {% for category in dashboard_category_rows %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ category.label }}</span>
                  <span class="fw-semibold">${{ '%.0f' | format(category.value) }}</span>
                </div>
                <div class="progress mt-2" role="progressbar" aria-valuenow="{{ category.share }}" aria-valuemin="0"
                  aria-valuemax="100">
                  <div class="progress-bar bg-info" style="width: {{ '%.0f' | format(category.share) }}%"></div>
                </div>
                <div class="text-muted small mt-1">{{ '%.0f' | format(category.share) }}% of gross sales</div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body">
        <h4 class="h6">Semantic layer snapshot</h4>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">Metric</th>
                <th scope="col">Aggregation</th>
                <th scope="col">Expression</th>
                <th scope="col">Description</th>
              </tr>
            </thead>
            <tbody>
              {% for semantic in dashboard_semantic_rows %}
              <tr>
                <th scope="row">{{ semantic.label }}</th>
                <td>{{ semantic.aggregation }}</td>
                <td><code>{{ semantic.expression }}</code></td>
                <td>{{ semantic.description }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  .timeline-highlight {
    animation: timelineHighlightPulse 2s ease-out;
    outline: 0.2rem solid rgba(13, 110, 253, 0.6);
    outline-offset: 0.1rem;
  }

  @keyframes timelineHighlightPulse {
    0% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.35);
    }

    100% {
      box-shadow: 0 0 0 1.5rem rgba(13, 110, 253, 0);
    }
  }

  .timeline-insight-card {
    background-color: #fff;
    border-radius: 0.5rem;
    border: 1px solid rgba(13, 110, 253, 0.1);
    padding: 0.75rem 1rem;
    height: 100%;
  }

  .timeline-insight-card .timeline-insight-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    letter-spacing: 0.03em;
    margin-bottom: 0.35rem;
  }

  .timeline-insight-card .timeline-insight-value {
    font-weight: 600;
    font-size: 1.1rem;
  }

  .timeline-insight-card .timeline-insight-description {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.35rem;
  }

  .timeline-link-highlight {
    font-size: 0.75rem;
  }
</style>
<script id="retailTimelineData" type="application/json">{{ timeline_events | tojson }}</script>
<script>
(function () {
  const dataScript = document.getElementById('retailTimelineData');
  if (!dataScript) {
    return;
  }
  let events = [];
  try {
    events = JSON.parse(dataScript.textContent || '[]');
  } catch (err) {
    console.error('Failed to parse retail timeline events', err);
    return;
  }
  if (!events.length) {
    return;
  }
  const listItems = Array.from(document.querySelectorAll('#retailTimelineList .list-group-item'));
  if (!listItems.length) {
    return;
  }
  const detailTitle = document.getElementById('retailTimelineDetailTitle');
  const detailBadge = document.getElementById('retailTimelineDetailBadge');
  const detailNarrative = document.getElementById('retailTimelineDetailNarrative');
  const detailInsights = document.getElementById('retailTimelineDetailInsights');
  const detailCallouts = document.getElementById('retailTimelineDetailCallouts');
  const detailLinks = document.getElementById('retailTimelineDetailLinks');
  const progress = document.getElementById('retailTimelineProgress');
  const activeLabel = document.getElementById('retailTimelineActiveLabel');
  const playBtn = document.getElementById('retailTimelinePlay');
  const nextBtn = document.getElementById('retailTimelineNext');
  let activeIndex = 0;
  let playing = false;
  let timer = null;
  const highlightTimers = new Map();

  function updatePlayButton() {
    if (!playBtn) {
      return;
    }
    if (playing) {
      playBtn.textContent = 'Pause';
      playBtn.classList.remove('btn-primary');
      playBtn.classList.add('btn-outline-primary');
    } else {
      playBtn.textContent = 'Play timeline';
      playBtn.classList.remove('btn-outline-primary');
      playBtn.classList.add('btn-primary');
    }
  }

  function stopPlayback() {
    playing = false;
    if (timer) {
      clearTimeout(timer);
      timer = null;
    }
    updatePlayButton();
  }

  function formatRichText(text) {
    const fragment = document.createDocumentFragment();
    const parts = String(text).split('`');
    parts.forEach(function (part, index) {
      if (index % 2 === 1) {
        const code = document.createElement('code');
        code.textContent = part;
        fragment.appendChild(code);
      } else if (part) {
        fragment.appendChild(document.createTextNode(part));
      }
    });
    if (!fragment.childNodes.length) {
      fragment.appendChild(document.createTextNode(String(text)));
    }
    return fragment;
  }

  function renderCallouts(items) {
    detailCallouts.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const header = document.createElement('h4');
    header.className = 'h6 text-uppercase text-muted mb-2';
    header.textContent = 'Focus points';
    detailCallouts.appendChild(header);
    const list = document.createElement('ul');
    list.className = 'ps-3 mb-0';
    items.forEach(function (item) {
      const li = document.createElement('li');
      li.className = 'mb-2';
      li.appendChild(formatRichText(item));
      list.appendChild(li);
    });
    detailCallouts.appendChild(list);
  }

  function highlightAnchor(anchorSelector) {
    if (!anchorSelector) {
      return;
    }
    const target = document.querySelector(anchorSelector);
    if (!target) {
      return;
    }
    try {
      target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    } catch (err) {
      console.warn('Unable to scroll to anchor', anchorSelector, err);
    }
    target.classList.add('timeline-highlight');
    if (highlightTimers.has(target)) {
      clearTimeout(highlightTimers.get(target));
    }
    const timeout = setTimeout(function () {
      target.classList.remove('timeline-highlight');
      highlightTimers.delete(target);
    }, 2000);
    highlightTimers.set(target, timeout);
  }

  function renderInsights(items) {
    if (!detailInsights) {
      return;
    }
    detailInsights.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const container = document.createElement('div');
    container.className = 'row g-3';
    items.forEach(function (item) {
      const col = document.createElement('div');
      col.className = 'col-sm-6';
      const card = document.createElement('div');
      card.className = 'timeline-insight-card';
      const label = document.createElement('div');
      label.className = 'timeline-insight-label';
      label.textContent = item.label || 'Insight';
      const value = document.createElement('div');
      value.className = 'timeline-insight-value';
      value.textContent = item.value || '';
      card.appendChild(label);
      card.appendChild(value);
      if (item.description) {
        const desc = document.createElement('div');
        desc.className = 'timeline-insight-description';
        desc.textContent = item.description;
        card.appendChild(desc);
      }
      col.appendChild(card);
      container.appendChild(col);
    });
    detailInsights.appendChild(container);
  }

  function renderLinks(items) {
    detailLinks.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const header = document.createElement('h4');
    header.className = 'h6 text-uppercase text-muted mb-2';
    header.textContent = 'Jump to assets';
    detailLinks.appendChild(header);
    const list = document.createElement('ul');
    list.className = 'ps-3 mb-0';
    items.forEach(function (item) {
      const li = document.createElement('li');
      const link = document.createElement('a');
      link.href = item.href || '#';
      link.textContent = item.label || item.href || 'Link';
      if ((item.href || '').startsWith('/')) {
        link.target = '_blank';
        link.rel = 'noopener';
      }
      li.appendChild(link);
      if (item.anchor) {
        const focus = document.createElement('button');
        focus.type = 'button';
        focus.className = 'btn btn-link btn-sm px-1 timeline-link-highlight';
        focus.textContent = 'Highlight';
        focus.addEventListener('click', function (event) {
          event.preventDefault();
          highlightAnchor(item.anchor);
        });
        li.appendChild(focus);
      }
      list.appendChild(li);
    });
    detailLinks.appendChild(list);
  }

  function renderDetail(event) {
    detailBadge.textContent = event.milestone_label || 'Milestone';
    detailBadge.className = 'badge ' + (event.badge_class || 'text-bg-secondary') + ' text-uppercase';
    detailTitle.textContent = event.date + ' · ' + event.title;
    detailNarrative.textContent = event.narrative || event.summary || '';
    renderInsights(event.insights || []);
    renderCallouts(event.callouts || []);
    renderLinks(event.links || []);
  }

  function setActive(index, options) {
    if (index < 0 || index >= events.length) {
      return;
    }
    const opts = options || {};
    activeIndex = index;
    listItems.forEach(function (item, idx) {
      if (idx === index) {
        item.classList.add('active');
        if (opts.scroll !== false) {
          item.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }
      } else {
        item.classList.remove('active');
      }
    });
    const event = events[index];
    renderDetail(event);
    if (activeLabel) {
      activeLabel.textContent = event.date + ' · ' + event.title;
    }
    if (progress) {
      const pct = ((index + 1) / events.length) * 100;
      progress.style.width = pct + '%';
      progress.setAttribute('aria-valuenow', String(Math.round(pct)));
    }
  }

  function advance() {
    if (activeIndex >= events.length - 1) {
      stopPlayback();
      return;
    }
    setActive(activeIndex + 1);
    if (playing) {
      scheduleAdvance();
    }
  }

  function scheduleAdvance() {
    if (timer) {
      clearTimeout(timer);
    }
    timer = setTimeout(advance, 4000);
  }

  if (playBtn) {
    playBtn.addEventListener('click', function () {
      if (playing) {
        stopPlayback();
      } else {
        playing = true;
        updatePlayButton();
        if (!listItems[activeIndex].classList.contains('active')) {
          setActive(activeIndex, { scroll: false });
        }
        scheduleAdvance();
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', function () {
      stopPlayback();
      if (activeIndex >= events.length - 1) {
        setActive(0);
      } else {
        setActive(activeIndex + 1);
      }
    });
  }

  listItems.forEach(function (item, idx) {
    item.addEventListener('click', function () {
      stopPlayback();
      setActive(idx);
    });
  });

  setActive(0, { scroll: false });
  updatePlayButton();
})();
</script>
{% endblock %}
