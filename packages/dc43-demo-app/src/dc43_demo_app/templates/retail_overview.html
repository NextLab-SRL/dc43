{% extends "base.html" %}
{% block content %}
{% if message %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<div class="row align-items-center mb-4">
  <div class="col-lg-10 col-xl-8">
    <h1 class="display-5 fw-semibold mb-3">Altair Retail data product suite</h1>
    <p class="lead mb-3">
      Explore how Altair Retail packages operational sources, a modeled star schema,
      a lightweight demand model, consumer activation, and executive analytics into
      a single governed flow.
    </p>
    <p class="text-muted mb-4">Business date: {{ business_date or "2024-03-31" }}</p>
    <p class="small text-muted">Explore the activation planner and dashboard directly on this page using the
      tabs in the experience section below.</p>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-3 col-xl-2 retail-overview-nav-column">
    <div class="retail-overview-nav card shadow-sm border-0">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted mb-3">Navigate</h2>
        <div class="nav nav-pills flex-column gap-2" id="retailNav">
          <a class="nav-link active" data-retail-nav href="#retail-run-card">Refresh demo run</a>
          <a class="nav-link" data-retail-nav data-tab-control="story-timeline-tab" href="#retail-story-card">Timeline player</a>
          <a class="nav-link" data-retail-nav data-tab-control="story-flow-tab" href="#retail-story-card">Flow at a glance</a>
          <a class="nav-link" data-retail-nav data-tab-control="story-lineage-tab" href="#retail-story-card">Dataset lineage</a>
          <a class="nav-link" data-retail-nav data-tab-control="story-catalog-tab" href="#retail-story-card">Catalog &amp; tools</a>
          <a class="nav-link" data-retail-nav data-tab-control="experience-offers-tab" href="#retail-experience-card">Offer highlights</a>
          <a class="nav-link" data-retail-nav data-tab-control="experience-activation-tab" href="#retail-experience-card">Marketing activation</a>
          <a class="nav-link" data-retail-nav data-tab-control="experience-dashboard-tab" href="#retail-experience-card">Executive dashboard</a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="card shadow-sm border-0 mb-4" id="retail-run-card">
      <div class="card-body">
        <h2 class="h5">Refresh the Altair Retail demo run</h2>
        <p class="mb-3">Everything on this page reads from a cached demo execution. Refresh the run to replay the packaged pipeline so the activation, dashboard, and timeline tabs stay aligned on the same snapshot.</p>
        <ol class="small ps-3 mb-3">
          <li>Load operational sources (`retail_pos_transactions`, `retail_inventory_snapshot`, `retail_product_catalog`).</li>
          <li>Rebuild the modelled snowflake schema (`retail_sales_fact` plus supporting dimensions).</li>
          <li>Engineer ML features and score the demand forecast.</li>
          <li>Publish marketing offers and aggregate the KPI mart.</li>
        </ol>
        <p class="small text-muted mb-3">The timeline tab animates these curated results instead of running the jobs live, so you always have a consistent story to present.</p>
        <form method="post" action="/retail-demo/run" class="d-flex align-items-center gap-3 flex-wrap">
          <button type="submit" class="btn btn-success">Refresh demo data</button>
          <span class="small text-muted">Rebuilds the cached fixtures in seconds.</span>
        </form>
      </div>
    </div>
    <div class="card shadow-sm border-0 mb-4" id="retail-story-card">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
          <div>
            <h2 class="h5 mb-1">Story, flow, and lineage</h2>
            <p class="small text-muted mb-0">Switch tabs to narrate the simulated incidents, highlight the product flow, or dive into dataset lineage.</p>
          </div>
        </div>
        <ul class="nav nav-tabs" id="storyTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="story-timeline-tab" data-bs-toggle="tab" data-bs-target="#story-timeline" type="button" role="tab" aria-controls="story-timeline" aria-selected="true">Timeline player</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="story-flow-tab" data-bs-toggle="tab" data-bs-target="#story-flow" type="button" role="tab" aria-controls="story-flow" aria-selected="false">Flow at a glance</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="story-lineage-tab" data-bs-toggle="tab" data-bs-target="#story-lineage" type="button" role="tab" aria-controls="story-lineage" aria-selected="false">Dataset lineage</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="story-catalog-tab" data-bs-toggle="tab" data-bs-target="#story-catalog" type="button" role="tab" aria-controls="story-catalog" aria-selected="false">Catalog &amp; tools</button>
          </li>
        </ul>
        <div class="tab-content pt-3" id="storyTabsContent">
          <div class="tab-pane fade show active" id="story-timeline" role="tabpanel" aria-labelledby="story-timeline-tab">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
              <div>
                <h3 class="h6 mb-1">Timeline player</h3>
                <p class="small text-muted mb-0">Animate six months of Altair Retail operations. The player pauses at milestones so you can narrate incidents, releases, and stakeholder outcomes.</p>
              </div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <button class="btn btn-primary btn-sm" id="retailTimelineNext" type="button">Start timeline</button>
                <button class="btn btn-outline-primary btn-sm" id="retailTimelineAuto" type="button">Auto play</button>
                <div class="small text-muted">Active:
                  <span class="fw-semibold" id="retailTimelineActiveLabel">Not started</span>
                </div>
              </div>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2 small text-muted mb-3">
              <span class="text-uppercase fw-semibold">Catalog quick links</span>
              <a class="link-secondary" data-retail-tab-link="catalog-products-tab" href="#retail-story-card">Data products</a>
              <a class="link-secondary" data-retail-tab-link="catalog-datasets-tab" href="#retail-story-card">Datasets</a>
              <a class="link-secondary" data-retail-tab-link="catalog-contracts-tab" href="#retail-story-card">Contracts</a>
            </div>
            <div class="progress mb-4" style="height: 6px;">
              <div class="progress-bar bg-primary" id="retailTimelineProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="row g-4">
              <div class="col-lg-5">
                <div class="list-group small" id="retailTimelineList">
                  {% for event in timeline_events %}
                  <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" data-index="{{ event.index }}">
                    <div class="ms-2 me-auto">
                      <div class="fw-semibold">{{ event.date }} · {{ event.title }}</div>
                      <div class="text-muted">{{ event.summary }}</div>
                    </div>
                    <span class="badge {{ event.badge_class }} rounded-pill text-uppercase">{{ event.milestone_label }}</span>
                  </button>
                  {% endfor %}
                </div>
              </div>
              <div class="col-lg-7">
                <div class="border rounded p-4 h-100 bg-light" id="retailTimelineDetail">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="badge text-bg-secondary text-uppercase" id="retailTimelineDetailBadge">Milestone</span>
                    <span class="fw-semibold" id="retailTimelineDetailTitle">Select a milestone to begin the demo.</span>
                  </div>
                  <p class="small text-primary fw-semibold mb-2 d-none" id="retailTimelineDetailState"></p>
                  <p class="small text-muted mb-3" id="retailTimelineDetailNarrative">Use the play controls to animate the story or click an individual milestone to jump ahead.</p>
                  <div id="retailTimelineDetailInsights" class="mb-3"></div>
                  <div id="retailTimelineDetailReplay" class="mb-3 d-none">
                    <h4 class="h6 text-uppercase text-muted">Pipeline replay</h4>
                    <div id="retailTimelineReplaySteps" class="timeline-replay-steps"></div>
                  </div>
                  <div id="retailTimelineDetailIncident" class="alert alert-warning d-none"></div>
                  <div id="retailTimelineDetailCallouts"></div>
                  <div id="retailTimelineDetailLinks" class="mt-3"></div>
                  <div id="retailTimelineDetailReject" class="timeline-reject-card mt-3 d-none">
                    <h4 class="h6 text-uppercase text-muted">Reject diagnostics</h4>
                    <div class="timeline-reject-meta small mb-3" id="retailTimelineRejectMeta"></div>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="timeline-reject-panel">
                          <div class="timeline-reject-title">Valid slice</div>
                          <pre class="timeline-reject-sample" id="retailTimelineRejectValid"></pre>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="timeline-reject-panel">
                          <div class="timeline-reject-title">Reject sample</div>
                          <pre class="timeline-reject-sample" id="retailTimelineRejectInvalid"></pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="story-flow" role="tabpanel" aria-labelledby="story-flow-tab">
            <p class="small text-muted">Each block represents a data product boundary. Internal datasets stay inside the product while exposed ports are surfaced downstream.</p>
            <div class="d-flex flex-wrap align-items-center gap-2 small text-muted mb-3">
              <span class="text-uppercase fw-semibold">Catalog quick links</span>
              <a class="link-secondary" data-retail-tab-link="catalog-products-tab" href="#retail-story-card">Data products</a>
              <a class="link-secondary" data-retail-tab-link="catalog-datasets-tab" href="#retail-story-card">Datasets</a>
              <a class="link-secondary" data-retail-tab-link="catalog-contracts-tab" href="#retail-story-card">Contracts</a>
            </div>
            <div class="mermaid">
{{ data_product_flow | safe }}
            </div>
          </div>
          <div class="tab-pane fade" id="story-lineage" role="tabpanel" aria-labelledby="story-lineage-tab">
            <p class="small text-muted">Datasets are grouped by the data product zone that owns them. Ports surface public interfaces while internal assets stay inside their product boundary.</p>
            <div class="d-flex flex-wrap align-items-center gap-2 small text-muted mb-3">
              <span class="text-uppercase fw-semibold">Catalog quick links</span>
              <a class="link-secondary" data-retail-tab-link="catalog-products-tab" href="#retail-story-card">Data products</a>
              <a class="link-secondary" data-retail-tab-link="catalog-datasets-tab" href="#retail-story-card">Datasets</a>
              <a class="link-secondary" data-retail-tab-link="catalog-contracts-tab" href="#retail-story-card">Contracts</a>
            </div>
            <div class="mermaid">
{{ dataset_lineage | safe }}
            </div>
          </div>
          <div class="tab-pane fade" id="story-catalog" role="tabpanel" aria-labelledby="story-catalog-tab">
            <p class="text-muted small mb-3">Jump between data products, datasets, and contracts without leaving the walkthrough.</p>
            <ul class="nav nav-tabs" id="catalogTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="catalog-products-tab" data-bs-toggle="tab" data-bs-target="#catalog-products" type="button" role="tab" aria-controls="catalog-products" aria-selected="true">Data products</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="catalog-datasets-tab" data-bs-toggle="tab" data-bs-target="#catalog-datasets" type="button" role="tab" aria-controls="catalog-datasets" aria-selected="false">Datasets</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="catalog-contracts-tab" data-bs-toggle="tab" data-bs-target="#catalog-contracts" type="button" role="tab" aria-controls="catalog-contracts" aria-selected="false">Contracts</button>
              </li>
            </ul>
            <div class="tab-content pt-3" id="catalogTabsContent">
              <div class="tab-pane fade show active" id="catalog-products" role="tabpanel" aria-labelledby="catalog-products-tab">
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th scope="col">Product</th>
                        <th scope="col">Owner</th>
                        <th scope="col">Tags</th>
                        <th scope="col">Ports</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for product in products %}
                      <tr id="{{ product.anchor }}">
                        <td>
                          <a class="fw-semibold" href="{{ product.url }}" target="_blank" rel="noopener">{{ product.name }}</a>
                          <div class="small text-muted">{{ product.identifier }}</div>
                          <div class="small"><a class="link-secondary" href="#{{ product.anchor }}">Highlight in walkthrough</a></div>
                        </td>
                        <td class="small">{{ product.owner.replace('-', ' ') | title }}</td>
                        <td>
                          {% for tag in product.tags %}
                          <span class="badge text-bg-light text-uppercase">{{ tag }}</span>
                          {% endfor %}
                        </td>
                        <td class="small">
                          <div><span class="text-muted text-uppercase">Inputs</span>: {{ product.inputs | join(', ') if product.inputs else 'None' }}</div>
                          <div><span class="text-muted text-uppercase">Outputs</span>: {{ product.outputs | join(', ') }}</div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane fade" id="catalog-datasets" role="tabpanel" aria-labelledby="catalog-datasets-tab">
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th scope="col">Dataset</th>
                        <th scope="col">Zone</th>
                        <th scope="col">Type</th>
                        <th scope="col">Data product</th>
                        <th scope="col">Contract</th>
                        <th scope="col">Port</th>
                        <th scope="col">Rows</th>
                        <th scope="col">Dependencies</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for dataset in dataset_catalog %}
                      <tr id="{{ dataset.anchor }}">
                        <td>
                          <a class="fw-semibold" href="{{ dataset.url }}" target="_blank" rel="noopener">{{ dataset.identifier }}</a>
                          <div class="small text-muted">{{ dataset.description }}</div>
                          {% if dataset.internal %}
                          <span class="badge text-bg-warning text-uppercase mt-1">Internal only</span>
                          {% endif %}
                          <div class="small"><a class="link-secondary" href="#{{ dataset.anchor }}">Highlight in walkthrough</a></div>
                        </td>
                        <td class="small">
                          {% set zone_parts = dataset.zone_label.split(' — ') %}
                          <span class="badge {{ dataset.zone_badge }} text-uppercase">{{ zone_parts[0] }}</span>
                          {% if zone_parts|length > 1 %}
                          <div class="text-muted">{{ zone_parts[1] }}</div>
                          {% endif %}
                        </td>
                        <td class="small text-uppercase">{{ dataset.kind }}</td>
                        <td class="small">
                          {% if dataset.data_product %}
                          <a href="{{ dataset.data_product.url }}" target="_blank" rel="noopener">{{ dataset.data_product.name }}</a>
                          <div class="text-muted">{{ dataset.data_product.identifier }}</div>
                          <div class="small"><a class="link-secondary" href="#{{ dataset.data_product.anchor }}">Highlight</a></div>
                          {% else %}
                          —
                          {% endif %}
                        </td>
                        <td class="small">
                          <a href="{{ dataset.contract_url }}" target="_blank" rel="noopener">{{ dataset.contract_id }}</a>
                          <div class="small"><a class="link-secondary" href="#{{ dataset.contract_anchor }}">Highlight</a></div>
                        </td>
                        <td class="small">{{ dataset.output_port or '—' }}</td>
                        <td class="small">{{ dataset.row_count }}</td>
                        <td class="small">
                          {% if dataset.dependencies %}
                          {% for dep in dataset.dependencies %}
                          <a href="{{ dep.url }}" target="_blank" rel="noopener" class="d-inline-block">{{ dep.identifier }}</a>{% if not loop.last %}, {% endif %}
                          {% endfor %}
                          {% else %}
                          None
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane fade" id="catalog-contracts" role="tabpanel" aria-labelledby="catalog-contracts-tab">
                <div class="row row-cols-1 row-cols-md-2 g-4">
                  {% for contract in contract_cards %}
                  <div class="col" id="{{ contract.anchor }}">
                    <div class="card h-100 shadow-sm border-0">
                      <div class="card-body">
                        <h3 class="h6 fw-semibold mb-1"><a href="{{ contract.url }}" target="_blank" rel="noopener">{{ contract.contract_id }}</a></h3>
                        <div class="small mb-2"><a class="link-secondary" href="#{{ contract.anchor }}">Highlight in walkthrough</a></div>
                        <div class="small text-muted mb-3">{{ contract.dataset_count }} dataset{{ 's' if contract.dataset_count != 1 else '' }} ·
                          {% for kind in contract.kinds %}<span class="badge text-bg-light text-uppercase me-1">{{ kind }}</span>{% endfor %}</div>
                        <div class="mb-3">
                          <div class="small text-muted text-uppercase mb-1">Datasets</div>
                          <ul class="list-unstyled mb-0">
                            {% for dataset_id in contract.dataset_ids %}
                            <li>
                              <a href="/datasets/{{ dataset_id }}" target="_blank" rel="noopener">{{ dataset_id }}</a>
                              <a class="link-secondary small ms-1" href="#dataset-{{ dataset_id }}">Highlight</a>
                            </li>
                            {% endfor %}
                          </ul>
                        </div>
                        {% if contract.product_refs %}
                        <div>
                          <div class="small text-muted text-uppercase mb-1">Data products</div>
                          <ul class="list-unstyled mb-0">
                            {% for ref in contract.product_refs %}
                            <li>
                              {% if ref.url %}
                              <a href="{{ ref.url }}" target="_blank" rel="noopener">{{ ref.name }}</a>
                              {% else %}
                              {{ ref.name or ref.identifier }}
                              {% endif %}
                              <span class="text-muted small">({{ ref.identifier }})</span>
                              {% if ref.anchor %}
                              <a class="link-secondary small ms-1" href="#{{ ref.anchor }}">Highlight</a>
                              {% endif %}
                            </li>
                            {% endfor %}
                          </ul>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card shadow-sm border-0 mb-4" id="retail-experience-card">
      <div class="card-body">
        <h2 class="h5 mb-3">Experience &amp; analytics walkthrough</h2>
        <p class="text-muted">Switch between the customer offer summary, activation planning workspace, and executive dashboard without leaving the page.</p>
        <ul class="nav nav-tabs" id="experienceTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="experience-offers-tab" data-bs-toggle="tab" data-bs-target="#experience-offers" type="button" role="tab" aria-controls="experience-offers" aria-selected="true">Offer highlights</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="experience-activation-tab" data-bs-toggle="tab" data-bs-target="#experience-activation" type="button" role="tab" aria-controls="experience-activation" aria-selected="false">Marketing activation</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="experience-dashboard-tab" data-bs-toggle="tab" data-bs-target="#experience-dashboard" type="button" role="tab" aria-controls="experience-dashboard" aria-selected="false">Executive dashboard</button>
          </li>
        </ul>
        <div class="tab-content pt-3" id="experienceTabsContent">
          <div class="tab-pane fade show active" id="experience-offers" role="tabpanel" aria-labelledby="experience-offers-tab">
            <div class="timeline-ui-banner alert alert-secondary d-none" data-ui-target="offers">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge text-bg-light text-uppercase timeline-ui-status"></span>
                <span class="timeline-ui-label fw-semibold"></span>
              </div>
              <div class="timeline-ui-message small mb-0"></div>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4">
              {% for store in store_cards %}
              <div class="col">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <div>
                        <h3 class="h5 mb-0">{{ store.store_name }}</h3>
                        <div class="text-muted small">{{ store.region }} · {{ store.format | title }}</div>
                      </div>
                      <span class="badge text-bg-primary">{{ store.offer_count }} offers</span>
                    </div>
                    <p class="mb-1">Leading category: <strong>{{ store.headline_category }}</strong></p>
                    <p class="mb-3 text-muted small">Primary KPI: {{ store.headline_metric.replace('_', ' ') | title }}</p>
                    <div class="mb-3">
                      <div class="small text-muted text-uppercase mb-1">Recommended discount</div>
                      <div class="fw-semibold fs-5">{{ '%.1f' | format(store.discount_pct) }}%</div>
                    </div>
                    <div class="mb-2">
                      <div class="small text-muted">Forecast confidence</div>
                      <div class="progress" role="progressbar" aria-valuenow="{{ store.confidence_pct }}" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-success" style="width: {{ '%.0f' | format(store.confidence_pct) }}%"></div>
                      </div>
                    </div>
                    <div>
                      <div class="small text-muted">Sell-through focus</div>
                      <div class="progress" role="progressbar" aria-valuenow="{{ store.sell_through_pct }}" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-info" style="width: {{ '%.1f' | format(store.sell_through_pct) }}%"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% else %}
              <div class="col">
                <div class="alert alert-info mb-0">No offers generated by the demo pipeline yet.</div>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="tab-pane fade" id="experience-activation" role="tabpanel" aria-labelledby="experience-activation-tab">
            <div class="timeline-ui-banner alert alert-secondary d-none" data-ui-target="activation">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge text-bg-light text-uppercase timeline-ui-status"></span>
                <span class="timeline-ui-label fw-semibold"></span>
              </div>
              <div class="timeline-ui-message small mb-0"></div>
            </div>
            {% for store in activation_stores %}
            <div class="card mb-4 shadow-sm border-0">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <h3 class="h6 mb-0">{{ store.store_name }}</h3>
                  <div class="text-muted small">{{ store.region }} · {{ store.format | title }}{% if store.square_feet %} · {{ store.square_feet | int }} sq ft{% endif %}</div>
                </div>
                <span class="badge text-bg-primary">{{ store.offers | length }} active offers</span>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-md-4">
                    <h4 class="h6 text-uppercase text-muted">KPI focus</h4>
                    <ul class="list-unstyled mb-0">
                      {% for mix in store.metric_mix %}
                      <li class="mb-2">
                        <span class="badge text-bg-secondary text-uppercase">{{ mix.metric_label }}</span>
                        <div class="text-muted small">{{ mix.count }} offer{% if mix.count != 1 %}s{% endif %} · {{ '%.0f' | format(mix.share) }}% of plan</div>
                      </li>
                      {% else %}
                      <li class="text-muted small">No KPI emphasis recorded.</li>
                      {% endfor %}
                    </ul>
                  </div>
                  <div class="col-md-8">
                    <div class="table-responsive">
                      <table class="table table-sm align-middle">
                        <thead class="table-light">
                          <tr>
                            <th scope="col">Offer</th>
                            <th scope="col" class="text-center">Category</th>
                            <th scope="col" class="text-center">KPI</th>
                            <th scope="col" class="text-end">Discount</th>
                            <th scope="col" class="text-end">Forecast units</th>
                            <th scope="col" class="text-end">Confidence</th>
                            <th scope="col" class="text-end">Sell-through</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for offer in store.offers %}
                          <tr>
                            <th scope="row">
                              <div class="fw-semibold">{{ offer.offer_id }}</div>
                              <div class="text-muted small">Customer {{ offer.customer_id }}</div>
                            </th>
                            <td class="text-center">{{ offer.category }}</td>
                            <td class="text-center">{{ offer.primary_metric_label }}</td>
                            <td class="text-end">{{ '%.1f' | format(offer.discount_pct) }}%</td>
                            <td class="text-end">
                              {{ '%.0f' | format(offer.forecast_units) }}
                              <div class="progress mt-1" role="progressbar" aria-valuenow="{{ offer.forecast_share }}" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: {{ '%.0f' | format(offer.forecast_share) }}%"></div>
                              </div>
                            </td>
                            <td class="text-end">{{ '%.0f' | format(offer.confidence_pct) }}%</td>
                            <td class="text-end">{{ '%.1f' | format(offer.sell_through_pct) }}%</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert alert-info">No offers generated by the demo pipeline yet.</div>
            {% endfor %}
          </div>
          <div class="tab-pane fade" id="experience-dashboard" role="tabpanel" aria-labelledby="experience-dashboard-tab">
            <div class="timeline-ui-banner alert alert-secondary d-none" data-ui-target="dashboard">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="badge text-bg-light text-uppercase timeline-ui-status"></span>
                <span class="timeline-ui-label fw-semibold"></span>
              </div>
              <div class="timeline-ui-message small mb-0"></div>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
              {% for metric in dashboard_metrics %}
              <div class="col">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body">
                    <div class="text-muted small">{{ metric.metric_id }}</div>
                    <div class="fw-semibold fs-4">{{ metric.value_display }}</div>
                    <div class="text-muted small">{{ metric.label }}</div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div class="row g-4 mb-4">
              <div class="col-lg-7">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body">
                    <h3 class="h6 text-uppercase text-muted">Regional momentum</h3>
                    <div class="table-responsive">
                      <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th scope="col">Region</th>
                            <th scope="col" class="text-end">YoY revenue</th>
                            <th scope="col" class="text-end">Offer lift</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in dashboard_region_rows %}
                          <tr>
                            <th scope="row">{{ row.region }}</th>
                            <td class="text-end">{{ row.revenue_display }}</td>
                            <td class="text-end">{{ row.offer_lift_display }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-5">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body">
                    <h3 class="h6 text-uppercase text-muted">Category mix</h3>
                    <div class="table-responsive">
                      <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th scope="col">Category</th>
                            <th scope="col" class="text-end">YoY revenue</th>
                            <th scope="col" class="text-end">Plan gap</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for row in dashboard_category_rows %}
                          <tr>
                            <th scope="row">{{ row.category }}</th>
                            <td class="text-end">{{ row.revenue_display }}</td>
                            <td class="text-end">{{ row.plan_gap_display }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <h3 class="h6 text-uppercase text-muted">Semantic layer</h3>
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Metric</th>
                        <th scope="col">Aggregation</th>
                        <th scope="col">Expression</th>
                        <th scope="col">Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in dashboard_semantic_rows %}
                      <tr>
                        <th scope="row">{{ row.label }}</th>
                        <td>{{ row.aggregation }}</td>
                        <td><code>{{ row.expression }}</code></td>
                        <td>{{ row.description }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
  .retail-overview-nav-column {
    max-width: 15rem;
  }

  @media (min-width: 992px) {
    .retail-overview-nav-column {
      flex: 0 0 15rem;
    }
  }

  .retail-overview-nav {
    border-radius: 0.75rem;
    width: 100%;
  }

  @media (min-width: 992px) {
    .retail-overview-nav {
      position: sticky;
      top: 6rem;
    }
  }

  .retail-overview-nav .nav-link {
    border-radius: 0.5rem;
    font-weight: 500;
    color: #495057;
  }

  .retail-overview-nav .nav-link:hover {
    background-color: rgba(13, 110, 253, 0.08);
    color: #0d6efd;
  }

  .retail-overview-nav .nav-link.active {
    background-color: rgba(13, 110, 253, 0.15);
    color: #0d6efd;
    box-shadow: inset 0 0 0 1px rgba(13, 110, 253, 0.25);
  }

  .timeline-highlight {
    animation: timelineHighlightPulse 2s ease-out;
    outline: 0.2rem solid rgba(13, 110, 253, 0.6);
    outline-offset: 0.1rem;
  }

  @keyframes timelineHighlightPulse {
    0% {
      box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.35);
    }

    100% {
      box-shadow: 0 0 0 1.5rem rgba(13, 110, 253, 0);
    }
  }

  .timeline-insight-card {
    background-color: #fff;
    border-radius: 0.5rem;
    border: 1px solid rgba(13, 110, 253, 0.1);
    padding: 0.75rem 1rem;
    height: 100%;
  }

  .timeline-insight-card .timeline-insight-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    letter-spacing: 0.03em;
    margin-bottom: 0.35rem;
  }

  .timeline-insight-card .timeline-insight-value {
    font-weight: 600;
    font-size: 1.1rem;
  }

  .timeline-insight-card .timeline-insight-description {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.35rem;
  }

  .timeline-link-highlight {
    font-size: 0.75rem;
  }

  .timeline-replay-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-replay-step {
    background-color: #fff;
    border-radius: 0.5rem;
    border: 1px solid rgba(13, 110, 253, 0.1);
    padding: 0.75rem 1rem;
    box-shadow: inset 0 0 0 1px rgba(13, 110, 253, 0.05);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .timeline-replay-step[data-status="running"] {
    border-color: rgba(13, 110, 253, 0.45);
    box-shadow: 0 0.45rem 1.2rem rgba(13, 110, 253, 0.18);
  }

  .timeline-replay-step[data-status="failed"] {
    border-color: rgba(220, 53, 69, 0.3);
    box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.2);
  }

  .timeline-replay-step-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .timeline-replay-badge {
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.03em;
  }

  .timeline-replay-label {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .timeline-replay-message {
    font-size: 0.85rem;
    color: #343a40;
    margin-bottom: 0.5rem;
  }

  .timeline-replay-rule {
    font-size: 0.8rem;
    color: #6c757d;
    background-color: rgba(255, 193, 7, 0.12);
    border-radius: 0.35rem;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
  }

  .timeline-replay-rule strong {
    color: #0c5460;
  }

  .timeline-replay-outputs {
    font-size: 0.78rem;
    color: #6c757d;
    margin-bottom: 0;
  }

  .timeline-replay-outputs dt {
    font-weight: 600;
  }

  .timeline-replay-outputs dd {
    margin-bottom: 0.35rem;
  }

  .timeline-ui-banner {
    border-width: 1px;
  }

  .timeline-ui-banner .timeline-ui-status {
    font-size: 0.65rem;
    letter-spacing: 0.03em;
  }

  .timeline-ui-banner .timeline-ui-label {
    font-size: 0.85rem;
  }

  .timeline-ui-banner .timeline-ui-message {
    color: #495057;
  }

  .timeline-reject-card {
    background-color: #f8f9fa;
    border-radius: 0.75rem;
    border: 1px solid rgba(13, 110, 253, 0.12);
    padding: 1rem 1.25rem;
  }

  .timeline-reject-panel {
    background-color: #fff;
    border-radius: 0.5rem;
    border: 1px solid rgba(13, 110, 253, 0.12);
    padding: 0.75rem;
    height: 100%;
  }

  .timeline-reject-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6c757d;
    letter-spacing: 0.04em;
    margin-bottom: 0.5rem;
  }

  .timeline-reject-sample {
    font-size: 0.75rem;
    background-color: #f8f9fa;
    border-radius: 0.35rem;
    border: 1px dashed rgba(13, 110, 253, 0.25);
    padding: 0.75rem;
    margin: 0;
    white-space: pre-wrap;
  }

  .timeline-incident-alert {
    font-size: 0.85rem;
  }
</style>
<script id="retailTimelineData" type="application/json">{{ timeline_events | tojson }}</script>
<script>
(function () {
  function renderMermaidDiagrams(attempt) {
    if (attempt === undefined) {
      attempt = 0;
    }
    if (!window.mermaid || typeof window.mermaid.run !== 'function') {
      if (attempt < 10) {
        setTimeout(function () {
          renderMermaidDiagrams(attempt + 1);
        }, 100);
      }
      return;
    }
    try {
      window.mermaid.run({ querySelector: '#storyTabsContent .mermaid' });
    } catch (err) {
      console.warn('Unable to render Mermaid diagrams', err);
    }
  }

  renderMermaidDiagrams();
  document.querySelectorAll('#storyTabs button[data-bs-toggle="tab"]').forEach(function (tab) {
    tab.addEventListener('shown.bs.tab', function () {
      renderMermaidDiagrams();
    });
  });

  const dataScript = document.getElementById('retailTimelineData');
  if (!dataScript) {
    return;
  }
  let events = [];
  try {
    events = JSON.parse(dataScript.textContent || '[]');
  } catch (err) {
    console.error('Failed to parse retail timeline events', err);
    return;
  }
  if (!events.length) {
    return;
  }
  const listItems = Array.from(document.querySelectorAll('#retailTimelineList .list-group-item'));
  if (!listItems.length) {
    return;
  }
  const detailTitle = document.getElementById('retailTimelineDetailTitle');
  const detailBadge = document.getElementById('retailTimelineDetailBadge');
  const detailState = document.getElementById('retailTimelineDetailState');
  const detailNarrative = document.getElementById('retailTimelineDetailNarrative');
  const detailInsights = document.getElementById('retailTimelineDetailInsights');
  const detailReplay = document.getElementById('retailTimelineDetailReplay');
  const detailReplaySteps = document.getElementById('retailTimelineReplaySteps');
  const detailIncident = document.getElementById('retailTimelineDetailIncident');
  const detailCallouts = document.getElementById('retailTimelineDetailCallouts');
  const detailLinks = document.getElementById('retailTimelineDetailLinks');
  const detailReject = document.getElementById('retailTimelineDetailReject');
  const detailRejectMeta = document.getElementById('retailTimelineRejectMeta');
  const detailRejectValid = document.getElementById('retailTimelineRejectValid');
  const detailRejectInvalid = document.getElementById('retailTimelineRejectInvalid');
  const progress = document.getElementById('retailTimelineProgress');
  const activeLabel = document.getElementById('retailTimelineActiveLabel');
  const nextBtn = document.getElementById('retailTimelineNext');
  const autoBtn = document.getElementById('retailTimelineAuto');
  const uiBanners = new Map();
  document.querySelectorAll('.timeline-ui-banner').forEach(function (banner) {
    const target = banner.getAttribute('data-ui-target');
    if (target) {
      uiBanners.set(target, banner);
    }
  });
  const highlightTimers = new Map();
  const replayTimers = [];
  const stepStates = [];
  let activeIndex = 0;
  let autoplaying = false;
  let timer = null;
  const stepStatusClasses = {
    running: 'text-bg-primary',
    success: 'text-bg-success',
    completed: 'text-bg-success',
    warning: 'text-bg-warning text-dark',
    blocked: 'text-bg-warning text-dark',
    failed: 'text-bg-danger',
    recovering: 'text-bg-info text-dark',
    investigating: 'text-bg-secondary',
    captured: 'text-bg-info text-dark',
  };
  const uiStatusClasses = {
    steady: 'alert-success',
    live: 'alert-success',
    recovering: 'alert-info',
    qa: 'alert-info',
    paused: 'alert-warning',
    fallback: 'alert-warning',
    blocked: 'alert-danger',
    stale: 'alert-warning',
    unstable: 'alert-danger',
    investigating: 'alert-secondary',
  };
  function updateNextButton() {
    if (!nextBtn) {
      return;
    }
    if (activeIndex === 0) {
      nextBtn.textContent = 'Start timeline';
    } else if (activeIndex >= events.length - 1) {
      nextBtn.textContent = 'Restart timeline';
    } else {
      nextBtn.textContent = 'Next milestone';
    }
  }
  function updateAutoButton() {
    if (!autoBtn) {
      return;
    }
    if (autoplaying) {
      autoBtn.textContent = 'Pause auto play';
      autoBtn.classList.remove('btn-outline-primary');
      autoBtn.classList.add('btn-primary');
    } else {
      autoBtn.textContent = 'Auto play';
      autoBtn.classList.remove('btn-primary');
      autoBtn.classList.add('btn-outline-primary');
    }
  }
  function clearReplayTimers() {
    while (replayTimers.length) {
      clearTimeout(replayTimers.pop());
    }
    stepStates.length = 0;
  }
  function stopPlayback() {
    autoplaying = false;
    if (timer) {
      clearTimeout(timer);
      timer = null;
    }
    clearReplayTimers();
    updateAutoButton();
  }
  function scheduleAdvance() {
    if (!autoplaying) {
      return;
    }
    if (timer) {
      clearTimeout(timer);
    }
    timer = setTimeout(advance, 4500);
  }
  function formatRichText(text) {
    const fragment = document.createDocumentFragment();
    const parts = String(text).split('`');
    parts.forEach(function (part, index) {
      if (index % 2 === 1) {
        const code = document.createElement('code');
        code.textContent = part;
        fragment.appendChild(code);
      } else if (part) {
        fragment.appendChild(document.createTextNode(part));
      }
    });
    if (!fragment.childNodes.length) {
      fragment.appendChild(document.createTextNode(String(text)));
    }
    return fragment;
  }
  function renderCallouts(items) {
    detailCallouts.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const header = document.createElement('h4');
    header.className = 'h6 text-uppercase text-muted mb-2';
    header.textContent = 'Focus points';
    detailCallouts.appendChild(header);
    const list = document.createElement('ul');
    list.className = 'ps-3 mb-0';
    items.forEach(function (item) {
      const li = document.createElement('li');
      li.className = 'mb-2';
      li.appendChild(formatRichText(item));
      list.appendChild(li);
    });
    detailCallouts.appendChild(list);
  }
  function highlightAnchor(anchorSelector) {
    if (!anchorSelector) {
      return;
    }
    const target = document.querySelector(anchorSelector);
    if (!target) {
      return;
    }
    try {
      target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    } catch (err) {
      console.warn('Unable to scroll to anchor', anchorSelector, err);
    }
    target.classList.add('timeline-highlight');
    if (highlightTimers.has(target)) {
      clearTimeout(highlightTimers.get(target));
    }
    const timeout = setTimeout(function () {
      target.classList.remove('timeline-highlight');
      highlightTimers.delete(target);
    }, 2000);
    highlightTimers.set(target, timeout);
  }
  function renderInsights(items) {
    if (!detailInsights) {
      return;
    }
    detailInsights.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const container = document.createElement('div');
    container.className = 'row g-3';
    items.forEach(function (item) {
      const col = document.createElement('div');
      col.className = 'col-sm-6';
      const card = document.createElement('div');
      card.className = 'timeline-insight-card';
      const label = document.createElement('div');
      label.className = 'timeline-insight-label';
      label.textContent = item.label || 'Insight';
      const value = document.createElement('div');
      value.className = 'timeline-insight-value';
      value.textContent = item.value || '';
      card.appendChild(label);
      card.appendChild(value);
      if (item.description) {
        const desc = document.createElement('div');
        desc.className = 'timeline-insight-description';
        desc.textContent = item.description;
        card.appendChild(desc);
      }
      col.appendChild(card);
      container.appendChild(col);
    });
    detailInsights.appendChild(container);
  }
  function renderLinks(items) {
    detailLinks.innerHTML = '';
    if (!items || !items.length) {
      return;
    }
    const header = document.createElement('h4');
    header.className = 'h6 text-uppercase text-muted mb-2';
    header.textContent = 'Jump to assets';
    detailLinks.appendChild(header);
    const list = document.createElement('ul');
    list.className = 'ps-3 mb-0';
    items.forEach(function (item) {
      const li = document.createElement('li');
      const link = document.createElement('a');
      link.href = item.href || '#';
      link.textContent = item.label || item.href || 'Link';
      if ((item.href || '').startsWith('/')) {
        link.target = '_blank';
        link.rel = 'noopener';
      }
      li.appendChild(link);
      if (item.anchor) {
        const focus = document.createElement('button');
        focus.type = 'button';
        focus.className = 'btn btn-link btn-sm px-1 timeline-link-highlight';
        focus.textContent = 'Highlight';
        focus.addEventListener('click', function (event) {
          event.preventDefault();
          highlightAnchor(item.anchor);
        });
        li.appendChild(focus);
      }
      list.appendChild(li);
    });
    detailLinks.appendChild(list);
  }
  function setStepStatus(state, statusKey, labelText) {
    const badge = state.badge;
    const className = stepStatusClasses[statusKey] || 'text-bg-secondary';
    badge.className = 'badge ' + className + ' timeline-replay-badge';
    badge.textContent = labelText || statusKey;
    state.element.setAttribute('data-status', statusKey);
  }
  function buildStepElement(step) {
    const wrapper = document.createElement('div');
    wrapper.className = 'timeline-replay-step';
    wrapper.setAttribute('data-status', 'pending');
    const header = document.createElement('div');
    header.className = 'timeline-replay-step-header';
    const badge = document.createElement('span');
    badge.className = 'badge text-bg-secondary timeline-replay-badge';
    badge.textContent = 'Pending';
    const label = document.createElement('span');
    label.className = 'timeline-replay-label';
    label.textContent = step.label || 'Step';
    header.appendChild(badge);
    header.appendChild(label);
    wrapper.appendChild(header);
    if (step.message) {
      const message = document.createElement('div');
      message.className = 'timeline-replay-message';
      message.textContent = step.message;
      wrapper.appendChild(message);
    }
    if (step.rule) {
      const ruleBox = document.createElement('div');
      ruleBox.className = 'timeline-replay-rule';
      if (step.rule.name) {
        const title = document.createElement('strong');
        title.textContent = step.rule.name + ': ';
        ruleBox.appendChild(title);
      }
      const body = document.createElement('span');
      const expected = step.rule.expected ? 'expected ' + step.rule.expected : '';
      const actual = step.rule.actual ? 'saw ' + step.rule.actual : '';
      body.textContent = [step.rule.message || step.message || '', expected, actual].filter(Boolean).join(' · ');
      ruleBox.appendChild(body);
      if (step.rule.impact) {
        const impact = document.createElement('div');
        impact.textContent = step.rule.impact;
        ruleBox.appendChild(impact);
      }
      wrapper.appendChild(ruleBox);
    }
    if (step.outputs) {
      const list = document.createElement('dl');
      list.className = 'timeline-replay-outputs';
      Object.keys(step.outputs).forEach(function (key) {
        const dt = document.createElement('dt');
        dt.textContent = key;
        const dd = document.createElement('dd');
        dd.textContent = String(step.outputs[key]);
        list.appendChild(dt);
        list.appendChild(dd);
      });
      wrapper.appendChild(list);
    }
    stepStates.push({ element: wrapper, badge, step });
    return wrapper;
  }
  function renderReplay(replay) {
    clearReplayTimers();
    if (!detailReplay || !detailReplaySteps) {
      return;
    }
    detailReplaySteps.innerHTML = '';
    if (!replay || !Array.isArray(replay.steps) || !replay.steps.length) {
      detailReplay.classList.add('d-none');
      return;
    }
    replay.steps.forEach(function (step) {
      detailReplaySteps.appendChild(buildStepElement(step));
    });
    detailReplay.classList.remove('d-none');
    let elapsed = 0;
    stepStates.forEach(function (state, index) {
      const startDelay = elapsed + (index === 0 ? 0 : 400);
      const finishDelay = startDelay + (state.step.duration_ms || 1500);
      replayTimers.push(setTimeout(function () {
        setStepStatus(state, 'running', 'Running');
      }, startDelay));
      replayTimers.push(setTimeout(function () {
        const statusKey = (state.step.status || 'success').toLowerCase();
        const label = state.step.status_label || statusKey;
        setStepStatus(state, statusKey, label);
      }, finishDelay));
      elapsed = finishDelay;
    });
  }
  function renderIncident(event) {
    if (!detailIncident) {
      return;
    }
    detailIncident.classList.add('d-none');
    detailIncident.innerHTML = '';
    const replay = event.replay || {};
    const steps = Array.isArray(replay.steps) ? replay.steps : [];
    const failing = steps.find(function (step) {
      return (step.status || '').toLowerCase() === 'failed' && step.rule;
    });
    if (!failing) {
      return;
    }
    const severity = (event.severity || '').toLowerCase();
    const severityClass = severity === 'danger' ? 'alert-danger' : 'alert-warning';
    detailIncident.className = 'alert timeline-incident-alert ' + severityClass;
    const title = document.createElement('div');
    title.className = 'fw-semibold mb-1';
    title.textContent = failing.rule.name || 'Rule violation';
    detailIncident.appendChild(title);
    const summary = document.createElement('div');
    summary.className = 'mb-2';
    summary.textContent = failing.message || event.summary || 'Contract validation failed.';
    detailIncident.appendChild(summary);
    const bullets = document.createElement('ul');
    bullets.className = 'ps-3 mb-0';
    if (failing.rule.expected) {
      const li = document.createElement('li');
      li.textContent = 'Expected ' + failing.rule.expected;
      bullets.appendChild(li);
    }
    if (failing.rule.actual) {
      const li = document.createElement('li');
      li.textContent = 'Observed ' + failing.rule.actual;
      bullets.appendChild(li);
    }
    if (failing.rule.impact) {
      const li = document.createElement('li');
      li.textContent = failing.rule.impact;
      bullets.appendChild(li);
    }
    detailIncident.appendChild(bullets);
    detailIncident.classList.remove('d-none');
  }
  function renderReject(reject) {
    if (!detailReject) {
      return;
    }
    detailReject.classList.add('d-none');
    if (!reject) {
      if (detailRejectMeta) {
        detailRejectMeta.textContent = '';
      }
      return;
    }
    if (detailRejectMeta) {
      const parts = [];
      if (reject.dataset) {
        parts.push('Dataset ' + reject.dataset);
      }
      if (reject.contract_version) {
        parts.push('Contract ' + reject.contract_version);
      }
      if (typeof reject.valid_rows !== 'undefined' && typeof reject.reject_rows !== 'undefined') {
        parts.push(String(reject.valid_rows) + ' valid · ' + String(reject.reject_rows) + ' reject');
      }
      detailRejectMeta.textContent = parts.join(' · ');
    }
    if (detailRejectValid) {
      const valid = reject.valid_sample && reject.valid_sample.length ? reject.valid_sample : [{ message: 'No valid sample captured.' }];
      detailRejectValid.textContent = JSON.stringify(valid, null, 2);
    }
    if (detailRejectInvalid) {
      const invalid = reject.reject_sample && reject.reject_sample.length ? reject.reject_sample : [{ message: 'No rejects emitted.' }];
      detailRejectInvalid.textContent = JSON.stringify(invalid, null, 2);
    }
    detailReject.classList.remove('d-none');
  }
  function applyUiState(uiState) {
    uiBanners.forEach(function (banner, key) {
      const state = uiState ? uiState[key] : null;
      if (!state) {
        banner.classList.add('d-none');
        return;
      }
      const statusKey = (state.status || '').toLowerCase();
      const className = uiStatusClasses[statusKey] || 'alert-secondary';
      banner.className = 'timeline-ui-banner alert ' + className;
      const statusEl = banner.querySelector('.timeline-ui-status');
      const labelEl = banner.querySelector('.timeline-ui-label');
      const messageEl = banner.querySelector('.timeline-ui-message');
      if (statusEl) {
        statusEl.textContent = state.label || (statusKey ? statusKey.toUpperCase() : 'STATUS');
      }
      if (labelEl) {
        labelEl.textContent = state.label || (statusKey ? statusKey.replace(/_/g, ' ') : '');
      }
      if (messageEl) {
        messageEl.textContent = state.message || '';
      }
      banner.classList.remove('d-none');
    });
  }
  function renderDetail(event) {
    detailBadge.textContent = event.milestone_label || 'Milestone';
    detailBadge.className = 'badge ' + (event.badge_class || 'text-bg-secondary') + ' text-uppercase';
    detailTitle.textContent = event.date + ' · ' + event.title;
    if (detailState) {
      if (event.state_summary) {
        detailState.textContent = event.state_summary;
        detailState.classList.remove('d-none');
      } else {
        detailState.textContent = '';
        detailState.classList.add('d-none');
      }
    }
    detailNarrative.textContent = event.narrative || event.summary || '';
    renderInsights(event.insights || []);
    renderReplay(event.replay || null);
    renderIncident(event);
    renderCallouts(event.callouts || []);
    renderLinks(event.links || []);
    renderReject(event.rejects || null);
  }
  function setActive(index, options) {
    if (index < 0 || index >= events.length) {
      return;
    }
    const opts = options || {};
    activeIndex = index;
    listItems.forEach(function (item, idx) {
      if (idx === index) {
        item.classList.add('active');
        if (opts.scroll !== false) {
          item.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        }
      } else {
        item.classList.remove('active');
      }
    });
    const event = events[index];
    renderDetail(event);
    applyUiState(event.ui_state || {});
    if (activeLabel) {
      let label = event.date + ' · ' + event.title;
      if (event.state_summary) {
        label += ' – ' + event.state_summary;
      }
      activeLabel.textContent = label;
    }
    if (progress) {
      const pct = ((index + 1) / events.length) * 100;
      progress.style.width = pct + '%';
      progress.setAttribute('aria-valuenow', String(Math.round(pct)));
    }
    updateNextButton();
  }
  function advance() {
    if (activeIndex >= events.length - 1) {
      stopPlayback();
      setActive(0, { scroll: false });
      return;
    }
    setActive(activeIndex + 1);
    if (autoplaying) {
      scheduleAdvance();
    }
  }
  if (autoBtn) {
    autoBtn.addEventListener('click', function () {
      if (autoplaying) {
        stopPlayback();
      } else {
        autoplaying = true;
        updateAutoButton();
        if (!listItems[activeIndex].classList.contains('active')) {
          setActive(activeIndex, { scroll: false });
        }
        scheduleAdvance();
      }
    });
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function () {
      stopPlayback();
      if (activeIndex >= events.length - 1) {
        setActive(0);
      } else {
        setActive(activeIndex + 1);
      }
    });
  }
  listItems.forEach(function (item, idx) {
    item.addEventListener('click', function () {
      stopPlayback();
      setActive(idx);
    });
  });
  setActive(0, { scroll: false });
  updateAutoButton();
  updateNextButton();
})();
</script>
<script>
(function () {
  const tabLinks = Array.from(document.querySelectorAll('[data-retail-tab-link]'));
  if (!tabLinks.length) {
    return;
  }
  tabLinks.forEach(function (link) {
    link.addEventListener('click', function () {
      const controlId = link.getAttribute('data-retail-tab-link');
      if (!controlId) {
        return;
      }
      const trigger = document.getElementById(controlId);
      if (trigger && window.bootstrap && window.bootstrap.Tab) {
        const tab = window.bootstrap.Tab.getOrCreateInstance(trigger);
        tab.show();
      }
    });
  });
})();
</script>
<script>
(function () {
  const navLinks = Array.from(document.querySelectorAll('[data-retail-nav]'));
  if (!navLinks.length) {
    return;
  }
  function setActive(link) {
    navLinks.forEach(function (item) {
      item.classList.toggle('active', item === link);
    });
  }
  const tabMap = new Map();
  navLinks.forEach(function (link) {
    const controlId = link.getAttribute('data-tab-control');
    if (controlId) {
      tabMap.set(controlId, link);
      link.addEventListener('click', function () {
        const trigger = document.getElementById(controlId);
        if (trigger && window.bootstrap && window.bootstrap.Tab) {
          const tab = window.bootstrap.Tab.getOrCreateInstance(trigger);
          tab.show();
        }
      });
    }
    link.addEventListener('click', function () {
      setActive(link);
    });
  });
  const observerLinks = [];
  navLinks.forEach(function (link) {
    if (link.hasAttribute('data-tab-control')) {
      return;
    }
    const href = link.getAttribute('href');
    if (!href || !href.startsWith('#')) {
      return;
    }
    const section = document.querySelector(href);
    if (section) {
      observerLinks.push({ link: link, section: section });
    }
  });
  if (observerLinks.length && 'IntersectionObserver' in window) {
    const observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          const found = observerLinks.find(function (item) {
            return item.section === entry.target;
          });
          if (found) {
            setActive(found.link);
          }
        }
      });
    }, { rootMargin: '-55% 0px -35% 0px', threshold: 0.1 });
    observerLinks.forEach(function (item) {
      observer.observe(item.section);
    });
  }
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(function (tab) {
    tab.addEventListener('shown.bs.tab', function (event) {
      const navLink = tabMap.get(event.target.id);
      if (navLink) {
        setActive(navLink);
        const href = navLink.getAttribute('href');
        if (href && href.startsWith('#')) {
          const section = document.querySelector(href);
          if (section) {
            try {
              section.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
            } catch (err) {
              console.warn('Unable to scroll to section', href, err);
            }
          }
        }
      }
    });
  });
})();
</script>
{% endblock %}
