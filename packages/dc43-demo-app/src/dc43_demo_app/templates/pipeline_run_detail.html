{% extends "base.html" %}
{% block content %}
<div class="mb-3">
  <a class="text-decoration-none" href="/pipeline-runs">&larr; Back to pipeline scenarios</a>
</div>

<div class="d-flex flex-wrap align-items-start gap-3 mb-3">
  <div>
    <h1 class="h2 mb-1">{{ scenario_row.label }}</h1>
    <div class="text-muted small">Scenario key: {{ scenario_key }}</div>
  </div>
  {% if category_label %}
  <span class="badge bg-secondary align-self-center">{{ category_label }}</span>
  {% endif %}
</div>

<form id="scenario-run-form" class="mb-4" method="post" action="/pipeline/run" data-scenario-category="{{ scenario_row.category }}">
  <input type="hidden" name="scenario" value="{{ scenario_key }}"/>
  {% set explicit_modes = mode_options if mode_options else [] %}
  {% set row_modes = scenario_row.mode_options if scenario_row.mode_options else [] %}
  {% set scenario_modes = scenario.mode_options if scenario.mode_options else [] %}
  {% set mode_options = explicit_modes if explicit_modes else (row_modes if row_modes else scenario_modes) %}
  {% if mode_options|length > 1 %}
  <div class="btn-group" role="group" aria-label="Run modes">
    {% for option in mode_options %}
    <button class="btn btn-primary" type="submit" name="mode" value="{{ option.mode }}">{{ option.label }}</button>
    {% endfor %}
  </div>
  {% elif mode_options|length == 1 %}
  {% set option = mode_options[0] %}
  <button class="btn btn-primary" type="submit" name="mode" value="{{ option.mode }}">{{ option.label }}</button>
  {% else %}
  <button class="btn btn-primary" type="submit">Run this scenario</button>
  {% endif %}
</form>

<div id="scenario-run-progress" class="alert alert-info d-none align-items-center d-flex" role="status">
  <div class="d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
    <span id="scenario-run-progress-text">Preparing run…</span>
  </div>
</div>

{% if scenario_row.category == 'streaming' %}
<div id="live-streaming-card" class="card mb-4 d-none">
  <div class="card-body">
    <h2 class="h5">Live streaming run</h2>
    <p id="live-streaming-status" class="small text-muted mb-3">Awaiting updates…</p>
    <div id="live-streaming-batches" class="d-flex flex-wrap gap-2 mb-3"></div>
    <ol id="live-streaming-timeline" class="list-unstyled mb-0"></ol>
  </div>
</div>
{% endif %}

{% set timeline_badges = {
  'success': 'bg-success',
  'ok': 'bg-success',
  'info': 'bg-primary',
  'warning': 'bg-warning text-dark',
  'danger': 'bg-danger',
  'error': 'bg-danger'
} %}
{% set stream_badges = {
  'success': 'border-success text-success',
  'ok': 'border-success text-success',
  'info': 'border-info text-info',
  'warning': 'border-warning text-warning',
  'danger': 'border-danger text-danger',
  'error': 'border-danger text-danger'
} %}

<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">Quick reference</h2>
    <dl class="row small mb-0">
      <dt class="col-sm-4">Primary dataset</dt>
      <dd class="col-sm-8">
        {% if dataset_name %}
          <a href="/datasets/{{ dataset_name }}">{{ dataset_name }}</a>
        {% else %}
          <span class="text-muted">None recorded</span>
        {% endif %}
      </dd>
      <dt class="col-sm-4">Contract</dt>
      <dd class="col-sm-8">
        {% set contract_id = (latest_record.contract_id if latest_record and latest_record.contract_id else scenario_row.contract_id) %}
        {% set contract_version = (latest_record.contract_version if latest_record and latest_record.contract_version else scenario_row.contract_version) %}
        {% if contract_id %}
          <a href="/contracts/{{ contract_id }}">{{ contract_id }}</a>
          {% if contract_version %}
            <span class="text-muted">/</span>
            <a href="/contracts/{{ contract_id }}/{{ contract_version }}">{{ contract_version }}</a>
          {% endif %}
        {% elif contract_version %}
          {{ contract_version }}
        {% else %}
          <span class="text-muted">No output contract</span>
        {% endif %}
      </dd>
      <dt class="col-sm-4">Default run type</dt>
      <dd class="col-sm-8">{{ scenario_row.run_type }}</dd>
      {% if latest_record and latest_record.draft_contract_version %}
      <dt class="col-sm-4">Latest draft</dt>
      <dd class="col-sm-8">
        {% if latest_record.contract_id %}
          <a href="/contracts/{{ latest_record.contract_id }}/{{ latest_record.draft_contract_version }}">{{ latest_record.draft_contract_version }}</a>
        {% else %}
          {{ latest_record.draft_contract_version }}
        {% endif %}
      </dd>
      {% endif %}
      {% if latest_record and latest_record.data_product_id %}
      <dt class="col-sm-4">Data product</dt>
      <dd class="col-sm-8">
        <a href="/data-products/{{ latest_record.data_product_id }}">{{ latest_record.data_product_id }}</a>
        {% if latest_record.data_product_port %}
          <span class="text-muted">/</span>
          <code>{{ latest_record.data_product_port }}</code>
        {% endif %}
        {% if latest_record.data_product_role %}
          <span class="badge bg-secondary text-uppercase ms-1">{{ latest_record.data_product_role }}</span>
        {% endif %}
      </dd>
      {% endif %}
    </dl>
    {% if activate_versions %}
    <div class="mt-3">
      <h3 class="h6">Default input slices</h3>
      <ul class="small mb-0 ps-3">
        {% for dataset, version in activate_versions.items() %}
          <li><code>{{ dataset }}</code> → <code>{{ version }}</code></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    {% if scenario_params.inputs or scenario_params.data_product_flow %}
    <details class="mt-3 small">
      <summary>Show raw configuration</summary>
      <pre class="small mb-0">{{ scenario_params | tojson(indent=2) }}</pre>
    </details>
    {% endif %}
  </div>
</div>

{% if scenario_row.description or scenario_row.diagram %}
<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">Scenario flow</h2>
    {% if scenario_row.description %}
      <div class="mb-3">{{ scenario_row.description | safe }}</div>
    {% endif %}
    {% if scenario_row.diagram %}
      {{ scenario_row.diagram | safe }}
    {% endif %}
  </div>
</div>
{% endif %}

{% if guide_sections %}
<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">Deep dive guide</h2>
    {% for section in guide_sections %}
      <section class="mb-4">
        <h3 class="h6">{{ section.title }}</h3>
        <div class="small">{{ section.content | safe }}</div>
      </section>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if latest_record %}
<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">Latest outcome</h2>
    <p class="small mb-2">
      The most recent run produced
      {% if latest_record.dataset_version %}
        <strong>{{ latest_record.dataset_version }}</strong>
      {% else %}
        no materialised dataset
      {% endif %}
      with status <span class="badge {{ status_badges.get(latest_record.status|lower, 'bg-secondary') }}">{{ latest_record.status }}</span>.
    </p>
    {% if latest_record.reason %}
    <p class="small text-muted mb-0">Reason: {{ latest_record.reason }}</p>
    {% endif %}
  </div>
</div>
{% endif %}

{% if latest_timeline %}
<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5">Streaming timeline</h2>
    {% if latest_batches %}
    {% set total_rows = latest_batches | sum(attribute='row_count') %}
    {% set total_violations = latest_batches | sum(attribute='violations') %}
    <p class="small text-muted">Processed {{ total_rows }} rows across {{ latest_batches|length }} micro-batches with {{ total_violations }} recorded violations.</p>
    <div class="d-flex flex-wrap gap-2 mb-3">
      {% for batch in latest_batches %}
      {% set status = batch.status if batch.status else 'info' %}
      {% set badge = stream_badges.get(status, 'border-secondary text-muted') %}
      <div class="border rounded px-3 py-2 small bg-light-subtle {{ badge }}">
        <div class="fw-semibold">Batch {{ batch.batch_id if batch.batch_id is not none else loop.index }}</div>
        {% if batch.time %}<div>at {{ batch.time }}</div>{% endif %}
        <div>Rows: {{ batch.row_count }}</div>
        <div>Violations: {{ batch.violations }}</div>
        {% if batch.intervention %}<div class="text-danger">Intervention: {{ batch.intervention }}</div>{% endif %}
        {% if batch.errors %}<div class="text-danger">{{ batch.errors|join(', ') }}</div>{% endif %}
        {% if batch.warnings %}<div class="text-warning">{{ batch.warnings|join(', ') }}</div>{% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    <ol class="list-unstyled mb-0">
      {% for event in latest_timeline %}
      {% set badge_key = event.status|lower if event.status else 'info' %}
      <li class="mb-3 border-start ps-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="small text-uppercase text-muted">{{ event.phase }}</span>
          <span class="badge {{ timeline_badges.get(badge_key, 'bg-secondary') }}">{{ badge_key }}</span>
        </div>
        <div class="fw-semibold">{{ event.title }}</div>
        <div class="small text-muted mb-1">
          {% if event.time %}<span class="me-2">{{ event.time }}</span>{% endif %}{{ event.description }}
        </div>
        {% if event.metrics %}
        <dl class="row row-cols-1 row-cols-md-2 small mb-0">
          {% for key, value in event.metrics.items() %}
          <dt class="col">{{ key }}</dt>
          <dd class="col">{{ value }}</dd>
          {% endfor %}
        </dl>
        {% endif %}
      </li>
      {% endfor %}
    </ol>
  </div>
</div>
{% endif %}

<h2 class="h4">Run history</h2>
{% if has_history %}
  {% for entry in history_entries %}
    {% set record = entry.record %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
          <div>
            <h3 class="h6 mb-1">
              {% if record.dataset_version %}
                Version {{ record.dataset_version }}
              {% else %}
                Planned run (no write)
              {% endif %}
            </h3>
            <div class="text-muted small">Run type: {{ record.run_type }}</div>
          </div>
          <span class="badge {{ status_badges.get(record.status|lower, 'bg-secondary') }}">{{ record.status }}</span>
        </div>
        <dl class="row small mb-0">
          {% if record.contract_id %}
          <dt class="col-sm-4">Contract</dt>
          <dd class="col-sm-8">
            <a href="/contracts/{{ record.contract_id }}">{{ record.contract_id }}</a>
            {% if record.contract_version %}
              <span class="text-muted">/</span>
              <a href="/contracts/{{ record.contract_id }}/{{ record.contract_version }}">{{ record.contract_version }}</a>
            {% endif %}
          </dd>
          {% elif record.contract_version %}
          <dt class="col-sm-4">Contract version</dt>
          <dd class="col-sm-8">{{ record.contract_version }}</dd>
          {% endif %}
          {% if record.draft_contract_version %}
          <dt class="col-sm-4">Draft proposed</dt>
          <dd class="col-sm-8">{{ record.draft_contract_version }}</dd>
          {% endif %}
          {% if record.data_product_id %}
          <dt class="col-sm-4">Data product</dt>
          <dd class="col-sm-8">
            <a href="/data-products/{{ record.data_product_id }}">{{ record.data_product_id }}</a>
            {% if record.data_product_port %}
              <span class="text-muted">/</span>
              <code>{{ record.data_product_port }}</code>
            {% endif %}
            {% if record.data_product_role %}
              <span class="badge bg-secondary text-uppercase ms-1">{{ record.data_product_role }}</span>
            {% endif %}
          </dd>
          {% endif %}
          {% if record.reason %}
          <dt class="col-sm-4">Reason</dt>
          <dd class="col-sm-8">{{ record.reason }}</dd>
          {% endif %}
          {% if entry.output_details.get('violation_strategy') %}
          <dt class="col-sm-4">Violation strategy</dt>
          <dd class="col-sm-8">{{ entry.output_details.get('violation_strategy') }}</dd>
          {% endif %}
          {% if record.violations %}
          <dt class="col-sm-4">Violations</dt>
          <dd class="col-sm-8">{{ record.violations }}</dd>
          {% endif %}
          {% if entry.input_refs %}
          {% for ref in entry.input_refs %}
          <dt class="col-sm-4">Input dataset</dt>
          <dd class="col-sm-8">
            <a href="/datasets/{{ ref.dataset }}">{{ ref.dataset }}</a>
            {% if ref.version %}
              <span class="text-muted ms-1">({{ ref.version }})</span>
            {% endif %}
          </dd>
          {% endfor %}
          {% endif %}
          {% if entry.reject_refs %}
          {% for ref in entry.reject_refs %}
          <dt class="col-sm-4">Reject dataset</dt>
          <dd class="col-sm-8">
            {% if ref.governed %}
              <a href="/datasets/{{ ref.dataset }}">{{ ref.dataset }}</a>
            {% else %}
              <code>{{ ref.dataset }}</code>
              <span class="text-muted ms-1">(ungoverned)</span>
            {% endif %}
            {% if ref.version %}
              <span class="text-muted ms-1">({{ ref.version }})</span>
            {% endif %}
            {% if ref.row_count is not none %}
              <span class="text-muted ms-1">– {{ ref.row_count }} rows</span>
            {% endif %}
            {% if ref.path %}
              <div class="text-muted small mt-1">Path: <code>{{ ref.path }}</code></div>
            {% endif %}
          </dd>
          {% endfor %}
          {% endif %}
        </dl>
        {% if entry.streaming_batches %}
        {% set history_rows = entry.streaming_batches | sum(attribute='row_count') %}
        <p class="small text-muted mb-2">Micro-batches: {{ entry.streaming_batches|length }}, rows processed: {{ history_rows }}.</p>
        <div class="d-flex flex-wrap gap-2 mb-3">
          {% for batch in entry.streaming_batches %}
          {% set status = batch.status if batch.status else 'info' %}
          {% set badge = stream_badges.get(status, 'border-secondary text-muted') %}
          <div class="border rounded px-2 py-1 small {{ badge }}">
            Batch {{ batch.batch_id if batch.batch_id is not none else loop.index }} · {{ batch.row_count }} rows{% if batch.violations %} · {{ batch.violations }} violations{% endif %}
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if entry.failed_expectations or entry.schema_errors or entry.dq_aux or entry.input_payloads or entry.output_details.get('warnings') %}
        <details class="mt-3">
          <summary class="small">Validation payload</summary>
          <div class="mt-2">
            {% if entry.failed_expectations %}
            <div class="mb-3">
              <strong class="small d-block mb-1">Failed expectations</strong>
              <ul class="small mb-0 ps-3">
                {% for key, info in entry.failed_expectations.items() %}
                  <li>
                    <code>{{ key }}</code> – {{ info.count }} rows
                    {% if info.expression %}
                      <span class="text-muted">({{ info.expression }})</span>
                    {% endif %}
                    {% if info.examples %}
                      <details class="mt-1">
                        <summary class="small">Examples</summary>
                        <pre class="small mb-0">{{ info.examples | tojson(indent=2) }}</pre>
                      </details>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if entry.schema_errors %}
            <div class="mb-3">
              <strong class="small d-block mb-1">Schema errors</strong>
              <ul class="small mb-0 ps-3">
                {% for err in entry.schema_errors %}
                  <li>{{ err }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if entry.output_details.get('warnings') %}
            <div class="mb-3">
              <strong class="small d-block mb-1">Warnings</strong>
              <ul class="small mb-0 ps-3">
                {% for warning in entry.output_details.get('warnings') %}
                  <li>{{ warning }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if entry.output_details.get('auxiliary_datasets') %}
            <div class="mb-3">
              <strong class="small d-block mb-1">Auxiliary datasets</strong>
              <ul class="small mb-0 ps-3">
                {% for aux in entry.output_details.get('auxiliary_datasets') %}
                  <li>
                    <span class="text-capitalize">{{ aux.kind }}</span> → <code>{{ aux.dataset }}</code>
                    {% if aux.path %}
                      <span class="text-muted">({{ aux.path }})</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if entry.dq_aux %}
            <div class="mb-3">
              <strong class="small d-block mb-1">Auxiliary DQ statuses</strong>
              <ul class="small mb-0 ps-3">
                {% for aux in entry.dq_aux %}
                  {% set details = aux.get('details') if aux.get('details') is mapping else {} %}
                  <li>
                    <code>{{ aux.get('dataset_id') }}</code> → {{ aux.get('status') }}
                    {% if details.get('draft_contract_version') %}
                      <span class="text-muted">(draft {{ details.get('draft_contract_version') }})</span>
                    {% endif %}
                    {% if details.get('reason') %}
                      <span class="text-muted"> – {{ details.get('reason') }}</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            {% if entry.input_payloads %}
            <div class="mb-0">
              <strong class="small d-block mb-1">Input validation</strong>
              {% for payload in entry.input_payloads %}
                <details class="small mb-2">
                  <summary>{{ payload.name }}</summary>
                  <pre class="small mb-0">{{ payload.payload | tojson(indent=2) }}</pre>
                </details>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </details>
        {% endif %}
        {% if entry.timeline %}
        <div class="mt-3">
          <strong class="small d-block mb-2">Streaming timeline</strong>
          <ol class="list-unstyled mb-0">
            {% for event in entry.timeline %}
            {% set badge_key = event.status|lower if event.status else 'info' %}
            <li class="mb-3 border-start ps-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-uppercase text-muted">{{ event.phase }}</span>
                <span class="badge {{ timeline_badges.get(badge_key, 'bg-secondary') }}">{{ badge_key }}</span>
              </div>
              <div class="fw-semibold">{{ event.title }}</div>
              <div class="small text-muted mb-1">
                {% if event.time %}<span class="me-2">{{ event.time }}</span>{% endif %}{{ event.description }}
              </div>
              {% if event.metrics %}
              <dl class="row row-cols-1 row-cols-md-2 small mb-0">
                {% for key, value in event.metrics.items() %}
                <dt class="col">{{ key }}</dt>
                <dd class="col">{{ value }}</dd>
                {% endfor %}
              </dl>
              {% endif %}
            </li>
            {% endfor %}
          </ol>
        </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">This scenario has not been run yet. Use the button above to trigger the first execution.</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('scenario-run-form');
    const scenarioCategory = form ? form.dataset.scenarioCategory : null;
    const isStreamingScenario = scenarioCategory === 'streaming';
    const liveCard = document.getElementById('live-streaming-card');
    const statusEl = document.getElementById('live-streaming-status');
    const batchesContainer = document.getElementById('live-streaming-batches');
    const timelineContainer = document.getElementById('live-streaming-timeline');
    const batchCards = new Map();
    const buttons = form ? Array.from(form.querySelectorAll('button[type="submit"]')) : [];
    const progressBar = document.getElementById('scenario-run-progress');
    const progressText = document.getElementById('scenario-run-progress-text');
    let eventSource = null;

    const timelineBadges = {
      success: 'bg-success',
      ok: 'bg-success',
      info: 'bg-primary',
      warning: 'bg-warning text-dark',
      danger: 'bg-danger',
      error: 'bg-danger'
    };
    const streamBadges = {
      success: 'border-success text-success',
      ok: 'border-success text-success',
      info: 'border-info text-info',
      warning: 'border-warning text-warning',
      danger: 'border-danger text-danger',
      error: 'border-danger text-danger'
    };

    function setButtonsBusy(active, submitter) {
      buttons.forEach((button) => {
        if (!button.dataset.originalLabel) {
          button.dataset.originalLabel = button.textContent || button.value || 'Run';
        }
        button.disabled = active;
        if (active && submitter === button) {
          button.innerHTML = '';
          const spinner = document.createElement('span');
          spinner.className = 'spinner-border spinner-border-sm me-2';
          spinner.setAttribute('role', 'status');
          spinner.setAttribute('aria-hidden', 'true');
          const label = document.createElement('span');
          label.textContent = 'Running…';
          button.appendChild(spinner);
          button.appendChild(label);
        } else if (!active) {
          button.innerHTML = button.dataset.originalLabel;
        }
      });
    }

    function showProgress(message) {
      if (!progressBar || !progressText) { return; }
      progressText.textContent = message || 'Running scenario…';
      progressBar.classList.remove('d-none');
    }

    function hideProgress() {
      if (!progressBar) { return; }
      progressBar.classList.add('d-none');
    }

    function formatTime(value) {
      if (!value) { return null; }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) { return null; }
      return date.toLocaleTimeString();
    }

    function renderStage(event) {
      if (!timelineContainer) { return; }
      const statusKey = String(event.status || 'info').toLowerCase();
      const item = document.createElement('li');
      item.className = 'mb-3 border-start ps-3';

      const header = document.createElement('div');
      header.className = 'd-flex justify-content-between align-items-center mb-1';
      const phase = document.createElement('span');
      phase.className = 'small text-uppercase text-muted';
      phase.textContent = event.phase || 'Update';
      header.appendChild(phase);
      const badge = document.createElement('span');
      badge.className = 'badge ' + (timelineBadges[statusKey] || 'bg-secondary');
      badge.textContent = statusKey;
      header.appendChild(badge);
      item.appendChild(header);

      const title = document.createElement('div');
      title.className = 'fw-semibold';
      title.textContent = event.title || 'Streaming update';
      item.appendChild(title);

      const desc = document.createElement('div');
      desc.className = 'small text-muted mb-1';
      const timeLabel = event.time || formatTime(event.timestamp);
      const description = event.description || '';
      desc.textContent = timeLabel ? timeLabel + ' ' + description : description;
      item.appendChild(desc);

      if (event.metrics && typeof event.metrics === 'object') {
        const metricsList = document.createElement('dl');
        metricsList.className = 'row row-cols-1 row-cols-md-2 small mb-0';
        Object.entries(event.metrics).forEach(([key, value]) => {
          const dt = document.createElement('dt');
          dt.className = 'col';
          dt.textContent = key;
          const dd = document.createElement('dd');
          dd.className = 'col';
          dd.textContent = value;
          metricsList.appendChild(dt);
          metricsList.appendChild(dd);
        });
        item.appendChild(metricsList);
      }

      timelineContainer.appendChild(item);
    }

    function renderBatch(event) {
      if (!batchesContainer) { return; }
      const statusKey = String(event.status || 'info').toLowerCase();
      const streamName = event.stream === 'reject' ? 'Reject batch' : 'Batch';
      const batchId = event.batch_id != null ? event.batch_id : batchCards.size + 1;
      const key = (event.stream || 'primary') + ':' + batchId;
      let card = batchCards.get(key);
      if (!card) {
        card = document.createElement('div');
        batchesContainer.appendChild(card);
        batchCards.set(key, card);
      }
      card.className = 'border rounded px-3 py-2 small bg-light-subtle ' + (streamBadges[statusKey] || 'border-secondary text-muted');
      const timeLabel = event.time || formatTime(event.timestamp);
      const rows = event.row_count != null ? event.row_count : 0;
      const violations = event.violations != null ? event.violations : 0;
      const parts = [
        `<div class="fw-semibold">${streamName} ${batchId}</div>`,
      ];
      if (timeLabel) {
        parts.push(`<div>at ${timeLabel}</div>`);
      }
      parts.push(`<div>Rows: ${rows}</div>`);
      parts.push(`<div>Violations: ${violations}</div>`);
      if (event.intervention) {
        parts.push(`<div class="text-danger">Intervention: ${event.intervention}</div>`);
      }
      if (Array.isArray(event.errors) && event.errors.length) {
        parts.push(`<div class="text-danger">${event.errors.join(', ')}</div>`);
      }
      if (Array.isArray(event.warnings) && event.warnings.length) {
        parts.push(`<div class="text-warning">${event.warnings.join(', ')}</div>`);
      }
      card.innerHTML = parts.join('');
    }

    function handleComplete(event) {
      if (statusEl) {
        statusEl.classList.remove('text-muted', 'text-warning');
        statusEl.classList.add(event.status === 'ok' ? 'text-success' : 'text-warning');
        const dataset = event.dataset_name || 'dataset';
        const version = event.dataset_version || 'unknown';
        statusEl.textContent = `Run completed for ${dataset}@${version}`;
        if (window.dc43Toast && typeof window.dc43Toast.show === 'function') {
          window.dc43Toast.show(`Streaming run finished for ${dataset}@${version}`, 'success');
        }
      }
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      hideProgress();
      window.setTimeout(function () {
        window.location.reload();
      }, 1500);
    }

    function handleError(message) {
      if (statusEl) {
        statusEl.classList.remove('text-muted');
        statusEl.classList.add('text-danger');
        statusEl.textContent = `Streaming run failed: ${message}`;
      }
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      setButtonsBusy(false);
      hideProgress();
      if (window.dc43Toast && typeof window.dc43Toast.show === 'function') {
        window.dc43Toast.show(`Streaming run failed: ${message}`, 'danger');
      }
    }

    function handleEvent(event) {
      if (!event || typeof event !== 'object') { return; }
      const type = String(event.type || '').toLowerCase();
      if (type === 'stage') {
        renderStage(event);
      } else if (type === 'batch') {
        renderBatch(event);
      } else if (type === 'observer-started') {
        renderStage({
          phase: 'Observation',
          title: 'Observation writer active',
          description: 'Streaming metrics query started.',
          status: 'info',
          timestamp: event.timestamp,
        });
      } else if (type === 'intervention') {
        renderStage({
          phase: 'Intervention',
          title: 'Streaming intervention triggered',
          description: event.reason || 'Intervention raised by strategy.',
          status: 'danger',
          timestamp: event.timestamp,
        });
      } else if (type === 'complete') {
        handleComplete(event);
      } else if (type === 'error') {
        handleError(event.message || 'Unknown error');
      } else if (type === 'started') {
        if (statusEl) {
          statusEl.classList.remove('text-danger', 'text-warning');
          statusEl.classList.add('text-muted');
          statusEl.textContent = 'Streaming run started…';
        }
      }
    }

    function listenToProgress(runId) {
      if (!window.EventSource) {
        handleError('This browser does not support live updates (EventSource).');
        return;
      }
      if (!liveCard) { return; }
      liveCard.classList.remove('d-none');
      if (statusEl) {
        statusEl.classList.remove('text-danger');
        statusEl.classList.add('text-muted');
        statusEl.textContent = 'Streaming run launched…';
      }
      eventSource = new EventSource(`/pipeline/streaming-progress/${runId}`);
      eventSource.onmessage = function (event) {
        try {
          const payload = JSON.parse(event.data);
          handleEvent(payload);
        } catch (err) {
          console.error('Failed to parse streaming event', err);
        }
      };
      eventSource.onerror = function () {
        if (statusEl && (!eventSource || statusEl.classList.contains('text-muted'))) {
          statusEl.classList.remove('text-danger');
          statusEl.classList.add('text-warning');
          statusEl.textContent = 'Connection interrupted, waiting for next update…';
        }
      };
    }

    function startStreamingRun(formData, submitter) {
      if (!form) { return; }
      setButtonsBusy(true, submitter);
      if (liveCard) {
        liveCard.classList.remove('d-none');
      }
      if (statusEl) {
        statusEl.classList.remove('text-danger');
        statusEl.classList.add('text-muted');
        statusEl.textContent = 'Starting streaming run…';
      }
      showProgress('Running streaming scenario…');
      fetch('/pipeline/run/streaming', {
        method: 'POST',
        body: formData,
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }
          return response.json();
        })
        .then(function (payload) {
          if (!payload || !payload.run_id) {
            throw new Error('Missing run identifier');
          }
          listenToProgress(String(payload.run_id));
        })
        .catch(function (error) {
          handleError(error.message || String(error));
        });
    }

    function startStandardRun(formData, submitter, mode) {
      setButtonsBusy(true, submitter);
      const modeLabel = mode === 'dlt' ? 'Running with Databricks DLT…' : 'Running Spark scenario…';
      showProgress(modeLabel);
      fetch('/pipeline/run', {
        method: 'POST',
        headers: { 'Accept': 'application/json' },
        body: formData,
      })
        .then(function (response) {
          if (!response.ok) {
            return response.json().catch(() => ({ status: 'error', message: `HTTP ${response.status}` }));
          }
          return response.json();
        })
        .then(function (payload) {
          if (!payload) {
            throw new Error('Unexpected empty response');
          }
          if (payload.status !== 'success') {
            throw new Error(payload.message || 'Run failed');
          }
          if (window.dc43Toast && typeof window.dc43Toast.show === 'function') {
            const toastLabel = payload.mode === 'dlt' ? 'DLT run finished successfully.' : 'Spark run finished successfully.';
            window.dc43Toast.show(payload.message || toastLabel, 'success');
          }
          const target = payload.detail_url || window.location.href;
          hideProgress();
          setTimeout(function () {
            window.location.href = target;
          }, 800);
        })
        .catch(function (error) {
          setButtonsBusy(false);
          hideProgress();
          if (window.dc43Toast && typeof window.dc43Toast.show === 'function') {
            window.dc43Toast.show(error.message || String(error), 'danger');
          }
        });
    }

    if (form) {
      form.addEventListener('submit', function (event) {
        if (!event) { return; }
        const submitter = event.submitter || null;
        const mode = submitter && submitter.name === 'mode' ? String(submitter.value || '').toLowerCase() : null;
        const formData = new FormData(form);
        if (submitter && submitter.name) {
          formData.set(submitter.name, submitter.value);
        }
        if (isStreamingScenario) {
          event.preventDefault();
          startStreamingRun(formData, submitter);
        } else {
          event.preventDefault();
          startStandardRun(formData, submitter, mode);
        }
      });
    }

    const mermaidNodes = document.querySelectorAll('.mermaid');
    if (mermaidNodes.length && window.mermaid) {
      if (typeof window.mermaid.run === 'function') {
        window.mermaid.run({ nodes: mermaidNodes });
      } else if (typeof window.mermaid.init === 'function') {
        window.mermaid.init(undefined, mermaidNodes);
      }
    }
  });
</script>
{% endblock %}
