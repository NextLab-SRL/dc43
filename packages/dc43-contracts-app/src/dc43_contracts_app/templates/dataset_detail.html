{% extends "base.html" %}
{% block content %}
<h1>Dataset {{ record.dataset_name }} {{ record.dataset_version }}</h1>
<p><a href="/datasets/{{ record.dataset_name }}">Back to versions</a></p>
<p>
  Contract:
  {% if record.contract_id %}
    <a href="/contracts/{{ record.contract_id }}">{{ record.contract_id }}</a>
    {% if record.contract_version %}
      <a href="/contracts/{{ record.contract_id }}/{{ record.contract_version }}">{{ record.contract_version }}</a>
    {% else %}
      <span class="text-muted">No version</span>
    {% endif %}
  {% else %}
    <span class="text-muted">No contract recorded for this run.</span>
  {% endif %}
</p>
{% if record.contract_id and record.draft_contract_version %}
<p>Draft Contract: <a href="/contracts/{{ record.contract_id }}/{{ record.draft_contract_version }}">{{ record.draft_contract_version }}</a></p>
{% endif %}
{% if data_products %}
<h2>Data product associations</h2>
<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th scope="col">Data product</th>
      <th scope="col">Port</th>
      <th scope="col">Role</th>
      <th scope="col">Status</th>
      <th scope="col">Version</th>
    </tr>
  </thead>
  <tbody>
  {% for entry in data_products %}
    <tr>
      <td>
        {% if entry.product_id %}
          <a href="/data-products/{{ entry.product_id }}">{{ entry.product_id }}</a>
        {% else %}
          <span class="text-muted">Unknown</span>
        {% endif %}
      </td>
      <td>
        {% if entry.port_name %}
          <code>{{ entry.port_name }}</code>
        {% else %}
          <span class="text-muted">n/a</span>
        {% endif %}
      </td>
      <td>
        {% if entry.role %}
          <span class="badge bg-secondary text-uppercase">{{ entry.role }}</span>
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </td>
      <td>{{ entry.status or 'unknown' }}</td>
      <td>{{ entry.dataset_version or '—' }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
{% set output_details = record.dq_details.get('output', {}) %}
<p>Status: {{ record.status }} | Run type: {{ record.run_type }}</p>
{% if output_details.get('violation_strategy') %}
<p><strong>Violation strategy:</strong> {{ output_details.get('violation_strategy') }}</p>
{% endif %}
{% set warnings = output_details.get('warnings', []) %}
{% if warnings %}
<div class="alert alert-warning">
  <strong>Warnings</strong>
  <ul class="mb-0">
    {% for warning in warnings %}
    <li>{{ warning }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% set metrics_summary = metrics_summary | default({}) %}
{% set latest_metrics = metrics_summary.get('latest') %}
{% set previous_metrics = metrics_summary.get('previous', []) %}
{% if metrics_error %}
<div class="alert alert-warning mt-3">
  <strong>Metrics unavailable.</strong>
  <div class="small mb-0">{{ metrics_error }}</div>
</div>
{% endif %}
{% if latest_metrics %}
<h2>Metrics</h2>
<div class="card mb-3">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
      <strong>{{ latest_metrics.recorded_label or latest_metrics.recorded_at or 'Latest snapshot' }}</strong>
      {% if latest_metrics.dataset_version %}
      <span class="text-muted ms-2">Dataset {{ latest_metrics.dataset_version }}</span>
      {% endif %}
    </div>
    {% if latest_metrics.contract_id %}
    <div class="text-muted small">
      Contract {{ latest_metrics.contract_id }}{% if latest_metrics.contract_version %}:{{ latest_metrics.contract_version }}{% endif %}
    </div>
    {% endif %}
  </div>
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead>
        <tr><th scope="col">Metric</th><th scope="col">Value</th></tr>
      </thead>
      <tbody>
        {% for metric in latest_metrics.metrics %}
        <tr>
          <td><code>{{ metric.key }}</code></td>
          <td>{{ metric.value }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% elif not metrics_error %}
<p class="text-muted">No metrics recorded for this dataset version.</p>
{% endif %}
{% if previous_metrics %}
<details class="mb-3">
  <summary>Earlier metric snapshots</summary>
  <div class="mt-3">
    {% for snapshot in previous_metrics %}
    <div class="card mb-3">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
          <strong>{{ snapshot.recorded_label or snapshot.recorded_at or 'Snapshot' }}</strong>
          {% if snapshot.dataset_version %}
          <span class="text-muted ms-2">Dataset {{ snapshot.dataset_version }}</span>
          {% endif %}
        </div>
        {% if snapshot.contract_id %}
        <div class="text-muted small">
          Contract {{ snapshot.contract_id }}{% if snapshot.contract_version %}:{{ snapshot.contract_version }}{% endif %}
        </div>
        {% endif %}
      </div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr><th scope="col">Metric</th><th scope="col">Value</th></tr>
          </thead>
          <tbody>
            {% for metric in snapshot.metrics %}
            <tr>
              <td><code>{{ metric.key }}</code></td>
              <td>{{ metric.value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
</details>
{% endif %}
{% set aux = output_details.get('auxiliary_datasets', []) %}
{% if aux %}
<h2>Auxiliary datasets</h2>
<table class="table table-sm">
  <thead><tr><th>Kind</th><th>Dataset</th><th>Path</th></tr></thead>
  <tbody>
  {% for entry in aux %}
  <tr>
    <td class="text-capitalize">{{ entry.kind }}</td>
    <td><code>{{ entry.dataset }}</code></td>
    <td>{% if entry.path %}<code>{{ entry.path }}</code>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
{% set fails = output_details.get('failed_expectations', {}) %}
<h2>Data Quality</h2>
{% if fails %}
<table class="table table-sm">
  <thead><tr><th>Name</th><th>Predicate</th><th>Count</th></tr></thead>
  <tbody>
  {% for key, info in fails.items() %}
  <tr><td>{{ key }}</td><td><code>{{ info.expression }}</code></td><td>{{ info.count }}</td></tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p>No data quality failures.</p>
{% endif %}
{% set schema_errors = output_details.get('errors', []) %}
{% if schema_errors %}
<div class="alert alert-danger">
  <strong>Schema errors</strong>
  <ul class="mb-0">
    {% for err in schema_errors %}
    <li>{{ err }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% set pipeline_activity = output_details.get('pipeline_activity', []) %}
{% if pipeline_activity %}
<h2>Pipeline activity</h2>
{% for entry in pipeline_activity %}
  <div class="card mb-3">
    <div class="card-header">
      <strong>Dataset version:</strong> {{ entry.dataset_version or 'unknown' }}
      {% if entry.contract_id and entry.contract_version %}
        <span class="ms-2 text-muted">Contract {{ entry.contract_id }}:{{ entry.contract_version }}</span>
      {% endif %}
    </div>
    <div class="card-body p-0">
      {% set events = entry.events or [] %}
      {% if events %}
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th scope="col">Recorded at</th>
              <th scope="col">Operation</th>
              <th scope="col">DQ Status</th>
              <th scope="col">Context</th>
            </tr>
          </thead>
          <tbody>
            {% for event in events %}
            <tr>
              <td><code>{{ event.recorded_at or 'n/a' }}</code></td>
              <td>{{ event.operation or 'unknown' }}</td>
              <td>
                {% if event.dq_status %}
                  <span class="badge bg-secondary text-uppercase">{{ event.dq_status }}</span>
                {% else %}
                  <span class="text-muted">n/a</span>
                {% endif %}
              </td>
              <td><pre class="small mb-0">{{ event.pipeline_context or {} | tojson(indent=2) }}</pre></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="m-3 text-muted">No activity recorded.</p>
      {% endif %}
    </div>
  </div>
{% endfor %}
{% endif %}
<h2>Details</h2>
<pre class="small">{{ output_details | tojson(indent=2) }}</pre>
{% if data_preview %}
<h2>Data</h2>
<pre class="small">{{ data_preview }}</pre>
{% endif %}
{% endblock %}

