{% if show_metrics_history and numeric_metric_keys and chronological_history %}
<script>
  (function () {
    const canvas = document.getElementById('datasetMetricsChart');
    if (!canvas || !window.Chart) {
      return;
    }
    const history = {{ chronological_history | tojson }};
    const metricKeys = {{ numeric_metric_keys | tojson }};
    if (!Array.isArray(history) || !Array.isArray(metricKeys) || !history.length || !metricKeys.length) {
      return;
    }
    const labels = history.map((snapshot) => snapshot.recorded_label || snapshot.recorded_at || 'Snapshot');
    const datasetVersions = history.map((snapshot) => snapshot.dataset_version || '');
    const contractLabels = history.map((snapshot) => {
      if (!snapshot.contract_id) {
        return '';
      }
      return snapshot.contract_version ? `${snapshot.contract_id}:${snapshot.contract_version}` : snapshot.contract_id;
    });
    const palette = ['#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6610f2', '#20c997', '#6f42c1', '#0dcaf0', '#ffc107', '#343a40'];
    const datasets = metricKeys.map((key, index) => {
      const colour = palette[index % palette.length];
      const data = history.map((snapshot) => {
        const metric = (snapshot.metrics || []).find((item) => item.key === key);
        if (metric && metric.numeric_value !== null && metric.numeric_value !== undefined) {
          const value = Number(metric.numeric_value);
          return Number.isFinite(value) ? value : null;
        }
        return null;
      });
      if (!data.some((value) => value !== null)) {
        return null;
      }
      return {
        label: key,
        data,
        spanGaps: true,
        tension: 0.25,
        borderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 4,
        borderColor: colour,
        backgroundColor: `${colour}33`,
      };
    }).filter(Boolean);
    if (!datasets.length) {
      const wrapper = canvas.closest('.card');
      if (wrapper) {
        wrapper.classList.add('d-none');
      }
      return;
    }
    new window.Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'nearest',
        },
        plugins: {
          tooltip: {
            callbacks: {
              afterBody(items) {
                const index = items?.[0]?.dataIndex ?? 0;
                const parts = [];
                if (datasetVersions[index]) {
                  parts.push(`Dataset ${datasetVersions[index]}`);
                }
                if (contractLabels[index]) {
                  parts.push(`Contract ${contractLabels[index]}`);
                }
                return parts.join('\n');
              },
            },
          },
          legend: {
            display: true,
            position: 'bottom',
          },
        },
        scales: {
          x: {
            ticks: {
              autoSkip: true,
              maxRotation: 0,
            },
          },
          y: {
            beginAtZero: false,
            ticks: {
              precision: 2,
            },
          },
        },
      },
    });
  })();
</script>
{% endif %}
